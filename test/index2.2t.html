<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Independence Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
    h1 { text-align: center; }
    label { display: inline-block; width: 240px; }
    input[type="number"], input[type="range"] { width: 200px; }
    .container { background: #fff; padding: 20px; border-radius: 10px; max-width: 700px; margin: auto; }
    .section { margin-bottom: 20px; }
    .output { font-size: 1.2em; font-weight: bold; margin-top: 10px; }
    canvas { max-height: 400px; }
    .chart-container { position: relative; height: 400px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Financial Independence Tool</h1>

    <div class="section">
      <label for="currentInvestment">Current Retirement Investment ($):</label>
      <input type="number" id="currentInvestment" value="10000"><br/>
      
      <label for="desiredIncome">Desired Monthly Retirement Income ($):</label>
      <input type="number" id="desiredIncome" value="2000"><br/>
      
      <label for="monthlyContribution">Current Monthly Contribution ($):</label>
      <input type="number" id="monthlyContribution" value="100"><br/>

      <label for="inflationRate">Inflation Rate (%):</label>
      <input type="number" id="inflationRate" value="2"><br/>

      <label for="preReturn">Pre-Retirement Rate of Return (%):</label>
      <input type="range" id="preReturn" min="0" max="15" value="9">
      <span id="preReturnText">9</span>%<br/>

      <label for="postReturn">Post-Retirement Rate of Return (%):</label>
      <input type="range" id="postReturn" min="0" max="15" value="7">
      <span id="postReturnText">7</span>%<br/>

      <label for="startAge">Start Age:</label>
      <input type="range" id="startAge" min="18" max="64" value="25">
      <span id="startAgeText">25</span><br/>

      <label for="retireAge">Retirement Age:</label>
      <input type="range" id="retireAge" min="25" max="75" value="65">
      <span id="retireAgeText">65</span><br/>

      <label for="endAge">End Age:</label>
      <input type="range" id="endAge" min="66" max="100" value="85">
      <span id="endAgeText">85</span><br/>
    </div>

    <div class="section">
      <label for="drawdownToggle" title="Toggle between ending your money at end age, or perpetual income like FIRE.">
        Retirement Mode (Finite vs FIRE):
      </label>
      <input type="checkbox" id="drawdownToggle"><br/>

      <label for="finDollarModeToggle" title="Show FIN in future value or today's value.">
        Show FIN in Future Dollars:
      </label>
      <input type="checkbox" id="finDollarModeToggle"><br/>
    </div>

    <div class="section output">
      <div>FIN: <span id="finAmount">$0</span></div>
      <div>Monthly Shortfall: <span id="monthlyNeeded">$0</span></div>
    </div>

    <div class="chart-container">
      <canvas id="finChart"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
      const els = {};
      ['currentInvestment','desiredIncome','monthlyContribution',
       'inflationRate','preReturn','preReturnText','postReturn','postReturnText',
       'startAge','startAgeText','retireAge','retireAgeText','endAge','endAgeText',
       'monthlyNeeded','finAmount','drawdownToggle','finDollarModeToggle'].forEach(id=>{
         els[id]=document.getElementById(id);
      });

      let finChart;

      function validateAges(){
        let sa=+els.startAge.value, ra=+els.retireAge.value, ea=+els.endAge.value;
        if(ra<=sa){ ra=sa+1; els.retireAge.value=ra; els.retireAgeText.textContent=ra; }
        if(ea<=ra){ ea=ra+1; els.endAge.value=ea; els.endAgeText.textContent=ea; }
      }

      function calculateFIN(){
        validateAges();
        const ci=+els.currentInvestment.value||0;
        const di=+els.desiredIncome.value||0;
        const mc=+els.monthlyContribution.value||0;
        const inf=+els.inflationRate.value/100||0;
        const pre=+els.preReturn.value/100||0;
        const post=+els.postReturn.value/100||0;
        const sa=+els.startAge.value, ra=+els.retireAge.value, ea=+els.endAge.value;
        const yrsTo=ra-sa, yrsIn=ea-ra;
        const futureIncome=di*Math.pow(1+inf,yrsTo);
        const realRate=post-inf;

        const drawdownType = els.drawdownToggle.checked ? 'perpetual' : 'finite';
        const dollarMode = els.finDollarModeToggle.checked ? 'future' : 'today';

        let fin = 0;
        if(drawdownType === 'finite'){
          fin = post > 0 ? futureIncome*12*((1 - Math.pow(1 + post, -yrsIn)) / post) : futureIncome*12*yrsIn;
        } else {
          fin = realRate > 0 ? (di * 12) / realRate : di * 12 * 50;
        }

        if(dollarMode === 'today') {
          fin = fin / Math.pow(1+inf, yrsTo);
        }

        const fvCurr = ci * Math.pow(1+pre, yrsTo);
        const months = yrsTo * 12;
        const mRate = pre / 12;
        const fvCont = mRate > 0 ? mc * ((Math.pow(1 + mRate, months) - 1) / mRate) : mc * months;
        const totalFV = fvCurr + fvCont;
        const rem = Math.max(fin - totalFV, 0);
        const monthlyNeed = rem > 0 ? (mRate > 0 ? rem / ((Math.pow(1 + mRate, months) - 1) / mRate) : rem / months) : 0;

        els.finAmount.textContent = '$' + Math.round(fin).toLocaleString();
        els.monthlyNeeded.textContent = '$' + Math.round(monthlyNeed).toLocaleString();

        // Chart data
        const labels = [], balances = [];
        let balance = ci;

        for(let age=sa; age<=ra; age++){
          if(age > sa){
            balance += mc * 12;
            balance *= 1 + pre;
          }
          labels.push(age);
          balances.push(balance);
        }

        for(let age=ra+1; age<=ea; age++){
          balance *= 1 + post;
          balance -= futureIncome * 12;
          if(balance < 0) balance = 0;
          labels.push(age);
          balances.push(balance);
        }

        if(finChart) finChart.destroy();
        const ctx = document.getElementById('finChart').getContext('2d');
        finChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Portfolio Value',
              data: balances,
              fill: true,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0,123,255,0.2)',
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: {
                  usePointStyle: true,
                  pointStyle: 'line'
                }
              },
              tooltip: {
                callbacks: {
                  label: ctx => '$' + ctx.parsed.y.toLocaleString()
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: v => '$' + v.toLocaleString()
                }
              }
            }
          }
        });
      }

      ['input', 'change'].forEach(evt => {
        document.querySelectorAll('input').forEach(el => {
          el.addEventListener(evt, () => {
            if(el.id.endsWith('Text')) return;
            const mirror = document.getElementById(el.id + 'Text');
            if(mirror) mirror.textContent = el.value;
            calculateFIN();
          });
        });
      });

      window.addEventListener('DOMContentLoaded', () => {
        calculateFIN();
      });
    </script>
  </div>
</body>
</html>

