<!DOCTYPE html>
<html lang="en">
<head>
	
	
	<!--
Copyright Â© 2025 Dmitri Ivanenko, Team Canada Financial Tool. All Rights Reserved.
Created by Dmitri Ivanenko, June 10, 2025 (initial)
This tool is provided for personal use only.
No part of the source code, design, or content may be copied, reproduced, modified, or redistributed without prior written permission.
-->
	
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FIN tools</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1"></script>
<script>
  Chart.register(window['chartjs-plugin-annotation']);
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
<link rel="stylesheet" href="css/style.css">
<link rel="icon" type="image/x-icon" href="./favicon_io/favicon.ico?v=20250804">
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>


  

</head>
<body>
<!-- PASSWORD OVERLAY -->
  <div id="passwordOverlay" style="
    position: fixed; 
    top:0; left:0; right:0; bottom:0; 
    background: #222; 
    color: white; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    z-index: 9999;
  ">
    <label for="passwordInput" style="margin-bottom: 10px; font-size: 1.2rem;">Enter Password:</label>
    <input type="password" id="passwordInput" style="font-size:1rem; padding: 6px;" autocomplete="off" />
    <button id="passwordBtn" style="margin-top: 10px; padding: 8px 16px; font-size:1rem; cursor:pointer;">Submit</button>
    <div id="passwordError" style="color: #f44336; margin-top: 10px; display:none;">Wrong password, try again.</div>
  </div>

  <!-- PAGE CONTENT (initially hidden) -->
  <div id="content" style="display:none;">

<button id="calculatorBtn" onclick="document.getElementById('basicCalculator').classList.toggle('hidden')"
  style="position: fixed; top: 48px; left: 20px; z-index: 999;
         background: none; border: none; padding: 0; cursor: pointer;">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
       stroke="#1976d2" stroke-width="4" fill="none"
       style="width: 40px; height: 40px;">
    <!-- Outer calculator body -->
    <rect x="8" y="4" width="48" height="56" rx="6" ry="6"/>
    <!-- Screen area -->
    <rect x="12" y="8" width="40" height="12" rx="2" ry="2"/>
    <!-- Button grid: 3 columns x 3 rows -->
    <circle cx="20" cy="28" r="3"/>
    <circle cx="32" cy="28" r="3"/>
    <circle cx="44" cy="28" r="3"/>
    <circle cx="20" cy="40" r="3"/>
    <circle cx="32" cy="40" r="3"/>
    <circle cx="44" cy="40" r="3"/>
    <circle cx="20" cy="52" r="3"/>
    <circle cx="32" cy="52" r="3"/>
    <circle cx="44" cy="52" r="3"/>
  </svg>
</button>

<div class="tab-wrapper">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="fin">FIN Calculator</button>
      <button class="tab-btn" data-tab="rdsp">RDSP</button>
      <button class="tab-btn" data-tab="resp">RESP</button>
      <button class="tab-btn" data-tab="tfsa">TFSA / RRSP</button>
      <button class="tab-btn" data-tab="btid">BTID vs WL</button>
      <button class="tab-btn" data-tab="tax">Tax Calculator</button>
      <button class="tab-btn" data-tab="budget">Budgeting</button>
      <button class="tab-btn" data-tab="fna">FNA</button>
       <div class="version-info"> <span data-tooltip=
      "<strong>Recent Updates
      </strong>
      <ul>(v2.0.54) Aug 15, 2025
      <li>added help overlay, keyboard shortcuts for core functions on the page</li>
      </ul>
      <li>adjusted the top bar for visibily improvement</li>
      </ul>
      <li>added a side menu, moved toggles to the side menu</li>
      </ul>
      <li>added tabs for future fintools, updated the menu to toggle tabs to see on the screen</li>
      </ul>      
      <ul>(v2.0.53) Aug 15, 2025
      <li>separated css from html, refactored css for tablets, laptops and desktops up to 1900+ resolutions</li>
      </ul>
      <ul>(v2.0.52) Aug 14, 2025
      <li>Optimized view for the 1920px screen size</li>
      </ul>
      <ul>(v2.0.51) Aug 12, 2025
      <li>Expanded chart is wider now for better visibility</li>
      </ul>
      <ul>(v2.0.50) Aug 5, 2025
      <li>Restricted Stop Saving Age to the range between start saving age and retirement age</li>
      </ul>
      <ul>(v2.0.49) Jul 30, 2025
      <li>Enhanced scenario buttons for parameters that show practical conversational points.</li>
      <li>Overhauled calculation engine for perfect accuracy (Target Plan now ends at $0).</li>
      <li>Redesigned 'Target Plan' to show an intuitive savings path from $0.</li>
      <li>Added independent start age for CPP benefits (60-70).</li>
      <li>Fixed 'Today's $' & 'Forever' mode calculations.</li>
      <li>Added conditional highlighting for successful plans.</li>
      <li>Redesigned end cotnribution age to a slider format with limited range from start to retirement age</li>
      </ul>
      ">v2.0.54</span> â€¢ Updated: August 15, 2025</div>
    </div>
<div id="shortcutHint" class="shortcut-hint-bar">
  ğŸ’¡ <strong>Shortcut:</strong> Press <kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>/</kbd> for Help and Shortcuts
</div>

    <div class="tab-content" id="tab-fin">
<!--<body class="debug-layout">-->
<div class="header">

<div class="header-flex">

<div class="header-flex-row" style="display: flex; align-items: flex-start; gap: 20px;">
<!-- Calculator Panel Start -->
<div id="basicCalculator" class="calculator-panel hidden"
style="position: fixed; top: 20px; left: 20px; z-index: 1000;
       max-width: 320px; padding: 16px;
       background: var(--calc-bg, #23272d);
       color: var(--calc-text, #fff);
       border-radius: 14px; box-shadow: 0 2px 8px #0003;">

  <div id="calcDragHandle" style="font-weight:bold;font-size:1.2em;margin-bottom:6px; cursor: move;">Basic Calculator</div>
  
  <!--close button for the draggable calculator-->
  <button class="calc-close" onclick="document.getElementById('basicCalculator').classList.add('hidden')"
style="position:absolute; top:10px; right:12px; background:none;  font-size:20px; border:none; cursor:pointer;">Ã—</button>

  <input id="calcDisplay" type="text" style="width:100%;padding:10px;font-size:1.3em;margin-bottom:12px;text-align:right;border:none;border-radius:6px;background:var(--calc-panel,#1a1c1e);color:var(--calc-text,#fff);" placeholder="0"  readonly>
  
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
    <button class="calc-btn" onclick="calcInput('7')">7</button>
    <button class="calc-btn" onclick="calcInput('8')">8</button>
    <button class="calc-btn" onclick="calcInput('9')">9</button>
    <button class="calc-btn" onclick="calcInput('/')">Ã·</button>

    <button class="calc-btn" onclick="calcInput('4')">4</button>
    <button class="calc-btn" onclick="calcInput('5')">5</button>
    <button class="calc-btn" onclick="calcInput('6')">6</button>
    <button class="calc-btn" onclick="calcInput('*')">Ã—</button>

    <button class="calc-btn" onclick="calcInput('1')">1</button>
    <button class="calc-btn" onclick="calcInput('2')">2</button>
    <button class="calc-btn" onclick="calcInput('3')">3</button>
    <button class="calc-btn" onclick="calcInput('-')">âˆ’</button>

    <button class="calc-btn" onclick="calcInput('0')">0</button>
    <button class="calc-btn" onclick="calcInput('.')">.</button>
    <button class="calc-btn" onclick="calcClear()">C</button>
    <button class="calc-btn" onclick="calcInput('+')">+</button>
  </div>

  <!-- Row for equals and backspace -->
  <div style="display:flex;gap:8px;margin-top:12px;">
    <button class="calc-btn" id="calcEquals" style="flex:2;" onclick="calcEquals()">=</button>
    <button class="calc-btn" style="flex:1;" onclick="calcBackspace()">âŒ«</button>
  </div>
</div>


<!-- Calculator Logic  -->
<script>
let calcBuffer = "";

function calcInput(char) {
  // Prevent multiple decimals in the same number
  if (char === '.' && calcBuffer.split(/[\+\-\*\/]/).pop().includes('.')) return;
  calcBuffer += char;
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcClear() {
  calcBuffer = "";
  document.getElementById('calcDisplay').value = "";
}
function calcBackspace() {
  calcBuffer = calcBuffer.slice(0, -1);
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcEquals() {
  try {
    if (/^[0-9+\-*/.() ]+$/.test(calcBuffer)) {
      let result = eval(calcBuffer);
      document.getElementById('calcDisplay').value = result;
      calcBuffer = String(result);
    } else {
      document.getElementById('calcDisplay').value = "Err";
      calcBuffer = "";
    }
  } catch {
    document.getElementById('calcDisplay').value = "Err";
    calcBuffer = "";
  }
}
</script>
<div class="top-layout-container">
  <!-- ğŸ”¹ LEFT COLUMN: Title + Version + Toggles -->
  <div class="top-left">
    <div class="header-left">
      <!--<h1 class="header-title">FIN Calculator</h1>-->
     
    </div>

<!-- Header Center Section -->
    <div class="header-center">
    
    </div> <!-- closes .header-center -->
  </div> <!-- closes .top-left -->
</div><!--closes

<!-- Scenario Buttons Row -->
<div class="top-interactive-area">

  <div id="scenario-row" class="scenario-buttons">
    <button class="scenario-btn active" data-scenario="default">Default</button>
    <button class="scenario-btn" data-scenario="child-zero">Child Born</button>
    <button class="scenario-btn" data-scenario="start-19">Start Age 19</button>
    <button class="scenario-btn" data-scenario="start-25">Start Age 25</button>
    <button class="scenario-btn" data-scenario="start-30">Start Age 30</button>
    <button class="scenario-btn" data-scenario="start-40">Start Age 40</button>
    <button class="scenario-btn" data-scenario="start-50">Start Age 50</button>
    <button class="scenario-btn" data-scenario="start-60">Start Age 60</button>
  </div>

  <div class="summary-bar">
    <div class="output tooltip-container" data-tooltip="Lump sum needed at desired retirement age to cover all future income goals (also known as Financial Independence Number).">
      <div class="label-row"><span class="icon">ğŸ’°</span> <span class="label-text">FIN</span></div>
      <strong id="finAmount">$0</strong>
    </div>
    <div class="output tooltip-container" data-tooltip="How much extra you'd need to save monthly to meet your financial independence target.">
      <div class="label-row"><span class="icon">ğŸ“…</span> <span class="label-text">Monthly FIN</span></div>
      <strong id="monthlyNeeded">$0</strong>
    </div>
    <div class="output tooltip-container" data-tooltip="How much you'd need invested TODAY to avoid having to put any extra MONTHLY contributions and still meet your retirement income goal.">
      <div class="label-row"><span class="icon">ğŸ¯</span> <span class="label-text">Fully Funded</span></div>
      <strong id="fullyFundedNow">$0</strong>
    </div>
    <div class="output tooltip-container" data-tooltip="Income Protection Number: Estimated life insurance need based on your current income requirement.">
      <div class="label-row"><span class="icon">ğŸ›¡ï¸</span> <span class="label-text">IPN</span></div>
      <strong id="incomeProtectionNumber">$0</strong>
    </div>
  </div>

</div>


</div><!--end of header-flex with title, version and toggles-->


</div>

<div id="ageWarning">âš ï¸ Invalid ages auto-adjusted.</div>
<div class="main-wrapper"> <!-- full body wrapper-->


<div class="main-layout"> <!-- the entire main page layout-->

<div class="left-column">

<div class="inputs-container"> <!-- Input boxes, sliders -->

  <!-- Row 1 -->
  <div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
    <div style="flex: 0.5;">
      <label for="desiredIncome" data-tooltip="Monthly income you want during retirement, in todayâ€™s dollars." class="tooltip-label">Income Goal</label>
      <input type="number" id="desiredIncome" />
    </div>
    <div style="flex: 0.5;">
      <label for="futureIncomeDisplay" data-tooltip="Inflation-adjusted monthly income at retirement age to match todayâ€™s value.">Future Value</label>
      <input type="text" id="futureIncomeDisplay" readonly />
    </div>
  </div>



  <div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
    <div style="flex: 0.5;">
      <label for="currentInvestment" data-tooltip="How much money have you saved so far, in the bank, mutual funds, stocks, GICs, CASH?">Savings Now</label>
      <input type="number" id="currentInvestment" />
    </div>
    <div style="flex: 0.5;">
      <label for="futureValueInvestmentDisplay" data-tooltip="Future value of your existing investments by retirement.">Future Value</label>
      <input type="text" id="futureValueInvestmentDisplay" class="readonly-box autoscale" readonly />
    </div>
  </div>
<div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
  <div style="flex: 0.5;">
    <label for="cppBenefit" data-tooltip="Enter your estimated monthly CPP (Canada Pension Plan) benefit in todayâ€™s dollars.">Monthly CPP</label>
    <input type="number" id="cppBenefit" value="0" />
  </div>
  <div style="flex: 0.5;">
    <label for="cppStartAge" data-tooltip="The age you plan to start receiving CPP benefits. Must be between 60 and 70.">at Age</label>
    <input type="number" id="cppStartAge" value="65" min="60" max="70" step="1" />
  </div>
</div>
  
  <!-- Row 2 -->
  <div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
    <div style="flex: 0.5;">
      <label for="monthlyContribution" data-tooltip="How much money are you putting away right now monthly?">Add Monthly</label>
      <input type="number" id="monthlyContribution" />
    </div>
    <div style="flex: 0.5;">
      <label for="futureValueContributionDisplay" data-tooltip="Total value of your contributions by retirement, including compounding growth.">Grows to $</label>
      <input type="text" id="futureValueContributionDisplay" class="readonly-box autoscale" readonly />
    </div>
  </div>

<div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
  <div style="flex: 0.5;">
    <label for="inheritanceAmount" data-tooltip="Lump sum amount you expect to receive (e.g., inheritance, sale of a house, etc) at a specific age. By entering a negative amount, you can also calculate the impact of a one time withdrawal at a specific age.">Windfall $</label>
    <input type="number" id="inheritanceAmount" min="0" value="0" />
  </div>
  <div style="flex: 0.5;">
    <label for="inheritanceAge" data-tooltip="Age at which you expect to receive the inheritance (must be between start age and retirement age).">at Age</label>
    <input type="number" id="inheritanceAge" min="0" value="0" step="1" />
  </div>
</div>

  <div class="slider-group">
    <label for="stopAge" data-tooltip="The age at which you plan to STOP monthly investing contributions. This age is dynamically updated to be between your Start Age and Retirement Age.">Stop Saving Age</label>
    <div class="slider-container">
      <input type="range" id="stopAge" min="0" max="100" step="1">
      <input type="text" id="stopAgeText">
    </div>
  </div>

  <!-- Row 3 -->
  <div class="slider-group">
    <label for="startAge" data-tooltip="Your current age or the age at which savings start.">Start Saving Age</label>
    <div class="slider-container">
      <input type="range" id="startAge" min="0" max="100" step="1">
      <input type="text" id="startAgeText">
    </div>
  </div>

  <div class="slider-group">
    <label for="preReturn" data-tooltip="Expected average annual rate of return on your investments before retirement, during accumulation phase.">Growth Rate %</label>
    <div class="slider-container">
      <input type="range" id="preReturn" min="0" max="9" step="1">
      <input type="text" id="preReturnText">
    </div>
  </div>

  <!-- Row 4 -->
  <div class="slider-group">
    <label for="retireAge" data-tooltip="The age when you stop working and begin withdrawals. For lifelong income, switch the mode to &quot;Forever&quot;.">Retirement Age</label>
    <div class="slider-container">
      <input type="range" id="retireAge" min="20" max="95" step="1">
      <input type="text" id="retireAgeText">
    </div>
  </div>

  <div class="slider-group">
    <label for="postReturn" data-tooltip="Expected average annual return on your investments during retirement or from the age you set for financial independence.">Retire Rate %</label>
    <div class="slider-container">
      <input type="range" id="postReturn" min="0" max="9" step="1">
      <input type="text" id="postReturnText">
    </div>
  </div>

  <!-- Row 5 -->
  <div class="slider-group">
    <label for="endAge" id="lifeLabel" data-tooltip="What's your life expectancy? Default is 100. In FIRE mode, your money is set to last forever.">Life Expectancy Age</label>
    <div class="slider-container">
      <input type="range" id="endAge" min="55" max="120" step="1">
      <input type="text" id="endAgeText">
    </div>
  </div>

  <div class="slider-group">
    <label for="inflationRate" data-tooltip="Average expected annual increase in cost of living.">Inflation Rate %</label>

    <div class="slider-container">
      <input type="range" id="inflationRate" min="0" max="7" step="1">
      <input type="text" id="inflationRateText">
    </div>
  </div>

</div> <!-- end of the input container -->

</div> <!--end of left-column-->

<div class="middle-column">

  <div class="graph-container"> <!--graph container starting-->

    <div id="finChartContainer">
  <canvas id="finChart"></canvas>

</div>

    
    <div style="display: flex; justify-content: center; gap: 15px;">
  <div class="graph-expand-btn-2" onclick="toggleGraphSize()">â†”ï¸ Expand the Chart</div>
</div>
<p class="chart-disclaimer">
    This illustrative calculator is designed to be an informational and educational tool only. This illustration is a hypothetical and does not represent an actual investment. This illustration uses a constant rate, compounded on a monthly basis, unlike actual investments which will fluctuate in value and could be significantly impacted by periods of negative returns. It does not include fees, taxes, expenses, or extra withdrawals before retirement, which if included, would lower results. Monthly withdrawal is at the beginning of the month, inflation applied annually. There is no guarantee you will achieve these results. The historical inflation rate is 3%.
  </p>

  </div> <!-- end of the graph-container-->



<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle FAQ main section
  const faqHeader = document.getElementById('faqHeader');
  const faqContent = document.getElementById('faqContent');
  const faqToggleIcon = document.getElementById('faqToggleIcon');

  faqHeader.addEventListener('click', () => {
    const expanded = faqHeader.getAttribute('aria-expanded') === 'true';
    faqHeader.setAttribute('aria-expanded', String(!expanded));
    faqContent.classList.toggle('open');
    faqContent.setAttribute('aria-hidden', String(expanded));
    faqToggleIcon.textContent = expanded ? 'â–¼' : 'â–²';
  });
  faqHeader.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      faqHeader.click();
    }
  });

  // Toggle individual FAQ questions
  document.querySelectorAll('.faq-question').forEach(question => {
    question.addEventListener('click', () => {
      const expanded = question.getAttribute('aria-expanded') === 'true';
      question.setAttribute('aria-expanded', String(!expanded));

      const answer = document.getElementById(question.getAttribute('aria-controls'));
      if (answer) {
        if (expanded) {
          answer.hidden = true;
          answer.classList.remove('open');
        } else {
          answer.hidden = false;
          answer.classList.add('open');
        }
      }
      question.classList.toggle('open');
    });

    question.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        question.click();

      }
    });
  });
  });
</script>

</div>



<div class="right-column"> <!--start of right-column-->

<!-- table view of the accumulation and decumulation -->
<div id="tableView" style="width:100%; max-width:900px; overflow-x:auto; margin-bottom:30px;"></div>
<section id="faq" aria-label="Frequently Asked Questions">
  <div id="faqHeader" tabindex="0" role="button" aria-expanded="false" aria-controls="faqContent">
    Frequently Asked Questions
    <span aria-hidden="true" id="faqToggleIcon">â–¼</span>
  </div>
  <div id="faqContent" role="region" aria-hidden="true">

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer1" id="question1">
        What is the FIN (Financial Independence Number)?
      </div>
      <div class="faq-answer" id="answer1" aria-labelledby="question1" hidden>
        The FIN represents the lump sum amount you need at retirement to generate your desired income for life.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer2" id="question2">
        Why does the FIN change for different start age?
      </div>
      <div class="faq-answer" id="answer2" aria-labelledby="question2" hidden>
        The FIN changes with start age because the amount you need at retirement depends on how many years you have to save and how inflation impacts the value of your desired income. Starting earlier means your desired income needs to be inflated over a longer period before retirement, which changes the lump sum required.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer3" id="question3">
        How is the â€œFuture $â€ display different from â€œToday's $â€?
      </div>
      <div class="faq-answer" id="answer3" aria-labelledby="question3" hidden>
        â€œFuture $â€ adjusts your income and savings goals to account for inflation, showing the amount of money you will need in inflated future dollars. â€œToday's $â€ shows the equivalent value in todayâ€™s dollars, removing the effects of inflation to provide a clearer comparison.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer4" id="question4">
        What does â€œFully Fundedâ€ mean?
      </div>
      <div class="faq-answer" id="answer4" aria-labelledby="question4" hidden>
        â€œFully Fundedâ€ shows how much youâ€™d need invested today to meet your retirement goals without adding extra monthly contributions.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer5" id="question5">
        What is the difference between Life Expectancy and Forever (FIRE style) modes?
      </div>
      <div class="faq-answer" id="answer5" aria-labelledby="question5" hidden>
        Life Expectancy mode plans your finances to last until a set age, while Forever (FIRE) mode plans for perpetual income with no set end date.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer6" id="question6">
        How do changes in inflation or investment return rates affect my results?
      </div>
      <div class="faq-answer" id="answer6" aria-labelledby="question6" hidden>
        Inflation and return rates impact how much you need to save and your investment growth, which affects your FIN and funding requirements.
      </div>
    </div>

  </div>
  
</div> <!--end of right-container-->
</div> <!-- end of the main-wrapper, full page-->
</div> <!-- âœ… END OF tab-content #tab-fin -->

</div> <!-- end of tab-wrapper-->
</div> <!-- end of #content -->

<!-- PASSWORD CHECK SCRIPT (must be the first script on the list)-->
  <script>
   document.addEventListener('DOMContentLoaded', () => {
  const correctPassword = 'fna4success';
  const overlay = document.getElementById('passwordOverlay');
  const content = document.getElementById('content');
  const input = document.getElementById('passwordInput');
  const btn = document.getElementById('passwordBtn');
  const errorMsg = document.getElementById('passwordError');

  // Check sessionStorage on load
  if (sessionStorage.getItem('accessGranted') === 'true') {
    overlay.style.display = 'none';
    content.style.display = 'block';
    return;
  }

  btn.addEventListener('click', checkPassword);
  input.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') checkPassword();
  });

  function checkPassword() {
    if (input.value === correctPassword) {
      sessionStorage.setItem('accessGranted', 'true');

      overlay.style.display = 'none';
      content.style.display = 'block';
      errorMsg.style.display = 'none';
    } else {
      errorMsg.style.display = 'block';
      input.value = '';
      input.focus();
    }
  }
});

  </script>
  
  
<!-- script to set the default for scenarios-->
<script>
 // Define the "all-zero" state specifically for the Default button
 const zeroScenario = {
    desiredIncome: 0,
    currentInvestment: 0,
    monthlyContribution: 0,
    cppBenefit: 0,
    cppStartAge: 65,
    stopAge: 65,
    inheritanceAmount: 0,
    inheritanceAge: 0,
    inflationRate: 2,
    preReturn: 9,
    postReturn: 7,
    startAge: 20,
    retireAge: 65,
    endAge: 85
 };

 // Define a base for the *active* scenarios (note: monthlyContribution is removed from here)
 const baseActiveScenario = {
    ...zeroScenario, 
    desiredIncome: 5000, 
 };

 // Rebuild the scenarios object with specific, calculated monthly contributions for each age
 const scenarios = {
    "default": zeroScenario,
    "child-zero": { ...baseActiveScenario, startAge: 0,  monthlyContribution: 0},
    "start-19":   { ...baseActiveScenario, startAge: 19, monthlyContribution: 0 },
    "start-25":   { ...baseActiveScenario, startAge: 25, monthlyContribution: 0 },
    "start-30":   { ...baseActiveScenario, startAge: 30, monthlyContribution: 0 },
    "start-40":   { ...baseActiveScenario, startAge: 40, monthlyContribution: 0 },
    "start-50":   { ...baseActiveScenario, startAge: 50, monthlyContribution: 0 },
    "start-60":   { ...baseActiveScenario, startAge: 60, monthlyContribution: 0 }
 };

Â  function setValue(id, value) {
Â  Â  const el = document.getElementById(id);
Â  Â  if (el) {
Â  Â  Â  el.value = value;
Â  Â  Â  el.dispatchEvent(new Event('input', { bubbles: true }));
Â  Â  }
Â  }

Â  document.querySelectorAll(".scenario-btn").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  // UI highlight
Â  Â  Â  document.querySelectorAll(".scenario-btn").forEach(b => b.classList.remove("active"));
Â  Â  Â  btn.classList.add("active");
localStorage.setItem('lastScenario', btn.dataset.scenario);

Â  Â  Â  const s = scenarios[btn.dataset.scenario];
Â  Â  Â  if (!s) return;

Â  Â  Â  // Set plain inputs
Â  Â  Â  setValue("desiredIncome", s.desiredIncome);
Â  Â  Â  setValue("currentInvestment", s.currentInvestment);
Â  Â  Â  setValue("monthlyContribution", s.monthlyContribution);
Â  Â  Â  setValue("cppBenefit", s.cppBenefit);Â 
Â  Â  Â  setValue("cppStartAge", s.cppStartAge);Â 
Â  Â  Â  setValue("stopAge", s.stopAge);
Â  Â  Â  setValue("inheritanceAmount", s.inheritanceAmount);
Â  Â  Â  setValue("inheritanceAge", s.inheritanceAge);

Â  Â  Â  // Set sliders + matching number inputs
Â  Â  Â  setValue("inflationRate", s.inflationRate);
Â  Â  Â  setValue("preReturn", s.preReturn);
Â  Â  Â  setValue("postReturn", s.postReturn);
Â  Â  Â  setValue("startAge", s.startAge);
Â  Â  Â  setValue("retireAge", s.retireAge);
Â  Â  Â  setValue("endAge", s.endAge);
Â  Â  });
Â  });
</script>


<script>
  let finChart;
  let isCurrentPlanSuccessful = false;
</script>

<script>
// Final, direct function for in-place graph expansion
let isChartExpanded = false;

function toggleGraphSize() {
  const mainLayout     = document.querySelector('.main-layout');
  const expandButton   = document.querySelector('.graph-expand-btn-2');
  const chartContainer = document.getElementById('finChartContainer');
  const canvas         = document.getElementById('finChart');
  const inputsContainer = document.querySelector('.inputs-container');

  if (!finChart || !mainLayout || !chartContainer || !inputsContainer) return;

  mainLayout.classList.toggle('chart-is-expanded');
  isChartExpanded = mainLayout.classList.contains('chart-is-expanded');

  // Let CSS control size; do NOT lock a pixel height
  chartContainer.style.removeProperty('height');
  canvas.style.removeProperty('height');
  canvas.style.removeProperty('width');

  if (isChartExpanded) {
    // Expanded: fill width, flexible height (no stretching)
    finChart.options.responsive = true;
    finChart.options.maintainAspectRatio = false;
    expandButton.innerHTML = 'â†”ï¸ Shrink View';
  } else {
    // Normal: restore usual responsive/aspect behavior
    finChart.options.responsive = true;
    finChart.options.maintainAspectRatio = true;
    expandButton.innerHTML = 'â†”ï¸ Expand the Chart';
  }

  finChart.update('none');
  finChart.resize();
}


</script>


<!--script to load/save settings locally-->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      
     const els = {};
['currentInvestment','desiredIncome','monthlyContribution','cppBenefit','cppStartAge',
 'stopAge','stopAgeText','inheritanceAmount','inheritanceAge', 
 'inflationRate','inflationRateText','preReturn','preReturnText',
 'postReturn','postReturnText','startAge','startAgeText',
 'retireAge','retireAgeText','endAge','endAgeText',
 'monthlyNeeded','finAmount','ageWarning'].forEach(id=>{
  els[id]=document.getElementById(id);
  });

const ctx = document.getElementById('finChart').getContext('2d');

finChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Target Plan (Required)',
        data: [],
        borderColor: '#1a73e8',
        backgroundColor: 'rgba(26,115,232,0.1)',
        fill: true,
        pointRadius: 3,
        pointHoverRadius: 6,
        tension: 0.25
      },
      {
        label: 'Your Current Plan',
        data: [],
        borderColor: '#fb8c00',
        backgroundColor: 'rgba(251,140,0,0.1)',
        fill: true,
        pointRadius: 3,
        pointHoverRadius: 6,
        tension: 0.25
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    aspectRatio: 1.78,
    scales: {
      x: {
        type: 'linear', // ğŸ› ï¸ THIS is the magic that makes annotations match!
        title: {
          display: true,
          text: 'Age (Years)'
        },
        ticks: {
          stepSize: 1, // show every year
          callback: value => value.toString()
        }
      },
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Portfolio Value ($)'
        },
        ticks: {
          callback: v => '$' + v.toLocaleString()
        }
      }
    },
    plugins: {
      legend: {
        labels: {
          usePointStyle: true,
          pointStyle: 'line'
        }
      },
      tooltip: {
        callbacks: {
          label: ctx => '$' + ctx.parsed.y.toLocaleString()
        }
      },
      title: {
        display: true,
        text: 'Portfolio Growth & Drawdown'
      },
      annotation: {
        drawTime: 'afterDraw',
        annotations: {} // will be filled dynamically in calculateFIN()
      }
    }
  }
});


        document.getElementById("drawdownToggle").addEventListener("change", function () {
        const isFire = this.checked;
        document.getElementById("modeLabel").textContent = isFire ? "Forever)" : "Life Expectancy";

        // Also change the slider label for Life Expectancy
        const lifeLabel = document.querySelector('label[for="endAge"]');
        if (lifeLabel) {

          lifeLabel.textContent = isFire ? "Mode: Perpetual" : "Life Expectancy";
        }

        calculateFIN();
      });

        document.getElementById("finDisplayToggle").addEventListener("change", function () {
        const label = this.checked ? "Future $" : "Today's $";
        document.getElementById("finDisplayLabel").textContent = label;
        
        calculateFIN();
      });

function loadSettings(){
  const saved = localStorage.getItem('finToolSettings');
  if (saved) {
    const s = JSON.parse(saved);
    Object.keys(s).forEach(k => {
      if (els[k]) els[k].value = s[k];
    });

    // Set min/max for inheritanceAge based on loaded startAge and retireAge
    els.inheritanceAge.min = els.startAge.value;
    els.inheritanceAge.max = els.retireAge.value;

    // ğŸ¯ Match scenario by values
    const mapped = {
      desiredIncome: +s.desiredIncome,
      currentInvestment: +s.currentInvestment,
      monthlyContribution: +s.monthlyContribution,
      stopAge: +s.stopAge,
      inheritanceAmount: +s.inheritanceAmount, // Add inheritance fields
      inheritanceAge: +s.inheritanceAge,
      inflationRate: +s.inflationRate,
      preReturn: +s.preReturn,
      postReturn: +s.postReturn,
      startAge: +s.startAge,
      retireAge: +s.retireAge,
      endAge: +s.endAge
    };

    let matchedScenario = 'custom';
    for (const [name, scenario] of Object.entries(scenarios)) {
      const isMatch = Object.entries(scenario).every(([key, val]) =>
        mapped.hasOwnProperty(key) && +mapped[key] === +val
      );
      if (isMatch) {
        matchedScenario = name;
        break;
      }
    }

    // âœ… Prefer last clicked scenario if stored
    const last = localStorage.getItem('lastScenario');
    const activeScenario = (last && scenarios[last]) ? last : matchedScenario;

    // ğŸ–±ï¸ Apply active scenario UI
    document.querySelectorAll(".scenario-btn").forEach(b => {
      b.classList.toggle("active", b.dataset.scenario === activeScenario);
    });
  } else {
    resetDefaults();
  }


  //calculateFIN();
}


// Function to update all chart colors based on the current theme
function updateChartColors() {
Â  Â  // Make sure the chart exists before trying to update it
Â  Â  if (!window.finChart) {
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const isDark = document.body.classList.contains('dark');

Â  Â  // Define color palettes for light and dark modes
Â  Â  const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
Â  Â  const textColor = isDark ? '#ddd' : '#666';
Â  Â  const titleColor = isDark ? '#eee' : '#222';
Â  Â  const annotationLabelBg = isDark ? '#444' : 'rgba(0,0,0,0.7)';
Â  Â  const annotationLabelColor = '#fff';

Â  Â  const options = finChart.options;

Â  Â  // 1. Update Target Plan (Dataset 0) Colors
Â  Â  finChart.data.datasets[0].borderColor = isDark ? '#42a5f5' : '#1a73e8';
Â  Â  finChart.data.datasets[0].backgroundColor = isDark ? 'rgba(66, 165, 245, 0.2)' : 'rgba(26, 115, 232, 0.1)';

    // --- MODIFIED: Update Current Plan (Dataset 1) Colors ---
    if (isCurrentPlanSuccessful) {
        // Use GREEN color scheme if the plan is successful
        finChart.data.datasets[1].borderColor = isDark ? '#81c784' : '#2e7d32';
        finChart.data.datasets[1].backgroundColor = isDark ? 'rgba(129, 199, 132, 0.2)' : 'rgba(46, 125, 50, 0.1)';
    } else {
        // Use the default ORANGE color scheme
        finChart.data.datasets[1].borderColor = isDark ? '#ffca28' : '#fb8c00';
        finChart.data.datasets[1].backgroundColor = isDark ? 'rgba(255, 202, 40, 0.2)' : 'rgba(251, 140, 0, 0.1)';
    }

Â  Â  // 2. Update Scale (Axes, Ticks, Grid) Colors
Â  Â  if (options.scales) {
        // Set the axis min/max and stepSize for better readability
        const sa = +document.getElementById('startAge').value;
        const ea = +document.getElementById('endAge').value;
        options.scales.x.min = sa;
        options.scales.x.max = ea;
        options.scales.x.ticks.stepSize = 5;
        
Â  Â  Â  Â  options.scales.x.grid.color = gridColor;
Â  Â  Â  Â  options.scales.y.grid.color = gridColor;
Â  Â  Â  Â  options.scales.x.ticks.color = textColor;
Â  Â  Â  Â  options.scales.y.ticks.color = textColor;
Â  Â  Â  Â  options.scales.x.title.color = textColor;
Â  Â  Â  Â  options.scales.y.title.color = textColor;
Â  Â  }

Â  Â  // 3. Update Plugin (Legend, Title, Annotations) Colors
Â  Â  if (options.plugins) {
Â  Â  Â  Â  if (options.plugins.legend) {
Â  Â  Â  Â  Â  Â  options.plugins.legend.labels.color = textColor;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (options.plugins.title) {
Â  Â  Â  Â  Â  Â  options.plugins.title.color = titleColor;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (options.plugins.annotation && options.plugins.annotation.annotations) {
Â  Â  Â  Â  Â  Â  Â Object.values(options.plugins.annotation.annotations).forEach(ann => {
Â  Â  Â  Â  Â  Â  Â  Â  if(ann.label) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ann.label.backgroundColor = annotationLabelBg;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ann.label.color = annotationLabelColor;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // 4. Trigger a chart update to apply the new colors
Â  Â  finChart.update();
}

// DARK MODE PERSISTENCE
const darkToggle = document.getElementById('darkModeToggle');

darkToggle.addEventListener('change', () => {
  document.body.classList.toggle('dark', darkToggle.checked);
  localStorage.setItem('darkMode', darkToggle.checked ? 'enabled' : 'disabled');
  
  // Call the centralized function to update all chart colors
  updateChartColors(); 
});

// Set the initial state of the toggle and theme when the page loads
if (localStorage.getItem('darkMode') === 'enabled') {
  document.body.classList.add('dark');
  darkToggle.checked = true;
}

     function saveSettings(){
  const data={};
  Object.keys(els).forEach(k=>{
    if(['monthlyNeeded','finAmount','ageWarning'].includes(k)) return;
    data[k]=els[k].value;
  });
  localStorage.setItem('finToolSettings',JSON.stringify(data));
}




      
function validateAges(){
  let sa = +els.startAge.value, ra = +els.retireAge.value, ea = +els.endAge.value, ia = +els.inheritanceAge.value, csa = +els.cppStartAge.value, warn = false;
  let warnText = 'âš ï¸ Invalid ages auto-adjusted.';

  if (ra <= sa) { 
    ra = sa + 1; 
    els.retireAge.value = ra; 
    els.retireAgeText.value = ra; 
    warn = true; 
  }
  if (ea <= ra) { 
    ea = ra + 1; 
    els.endAge.value = ea; 
    els.endAgeText.value = ea; 
    warn = true; 
  }
  if (ia !== 0 && (ia < sa || ia > ra)) { 
    ia = sa; 
    els.inheritanceAge.value = ia; 
    warn = true; 
    warnText = `âš ï¸ Inheritance age must be between ${sa} and ${ra}. Adjusted to ${ia}.`;
  }
  // New CPP Age Validation
  if (csa < 60 || csa > 70) {
    csa = Math.max(60, Math.min(csa, 70)); // Clamp between 60 and 70
    els.cppStartAge.value = csa;
    warn = true;
    warnText = `âš ï¸ CPP start age must be between 60 and 70. Adjusted to ${csa}.`;
  }

  els.ageWarning.textContent = warnText;
  els.ageWarning.style.display = warn ? 'block' : 'none';
  
  els.inheritanceAge.min = sa;
  els.inheritanceAge.max = ra;

// Set the min and max for the Stop Saving Age slider
  els.stopAge.min = sa;
  els.stopAge.max = ra;
  
  // If the current stop age is now invalid, fix it
  if (+els.stopAge.value < sa) {
      els.stopAge.value = sa;
      els.stopAgeText.value = sa;
  }
  if (+els.stopAge.value > ra) {
      els.stopAge.value = ra;
      els.stopAgeText.value = ra;
  }
}

// HELPER 1: Simulates the accumulation of savings until retirement.
function simulateAccumulation(ci, mc, stopAge, sa, ra, mRate, inheritanceAmount, inheritanceAge) {
    let balance = ci;
    for (let age = sa; age < ra; age++) {
        // Add windfall at the beginning of the year it's received
        if (inheritanceAge > 0 && age === inheritanceAge) {
            balance += inheritanceAmount;
        }
        for (let month = 1; month <= 12; month++) {
            // Contribution at the beginning of the month
            let contribution = (age < stopAge) ? mc : 0;
            balance = (balance + contribution) * (1 + mRate);
        }
    }
    return balance;
}

// HELPER 2: Simulates the drawdown of a portfolio during retirement. This is our "ground truth".
function simulateDrawdown(startingBalance, di, cppBenefit, cppStartAge, sa, ra, ea, inf, post) {
    let balance = startingBalance;
    const drawdownData = [{ age: ra, balance: balance }];
    for (let year = ra; year < ea; year++) {
        let annualWithdrawal = di * 12 * Math.pow(1 + inf, year - sa);
        if (cppBenefit > 0 && year >= cppStartAge) {
            annualWithdrawal -= (cppBenefit * 12 * Math.pow(1 + inf, year - sa));
        }
        annualWithdrawal = Math.max(0, annualWithdrawal);
        const monthlyWithdrawal = annualWithdrawal / 12;

        for (let month = 1; month <= 12; month++) {
            // Withdrawal at the beginning of the month
            balance = (balance - monthlyWithdrawal) * (1 + post / 12);
        }
        drawdownData.push({ age: year + 1, balance: Math.max(0, balance) });
    }
    return drawdownData;
}

// HELPER 3: Calculates the exact FIN by running the drawdown simulation in reverse.
function calculateRealFIN(di, cppBenefit, cppStartAge, sa, ra, ea, inf, post) {
    let requiredBalance = 0.0;
    for (let year = ea - 1; year >= ra; year--) {
        let annualWithdrawal = di * 12 * Math.pow(1 + inf, year - sa);
        if (cppBenefit > 0 && year >= cppStartAge) {
            annualWithdrawal -= (cppBenefit * 12 * Math.pow(1 + inf, year - sa));
        }
        annualWithdrawal = Math.max(0, annualWithdrawal);
        const monthlyWithdrawal = annualWithdrawal / 12;

        let startOfYearBalance = requiredBalance;
        for (let month = 12; month >= 1; month--) {
            // Reverse logic for BEGINNING-of-month withdrawal
            startOfYearBalance = (startOfYearBalance / (1 + post / 12)) + monthlyWithdrawal;
        }
        requiredBalance = startOfYearBalance;
    }
    return requiredBalance;
}

function calculateFIN() {
    // This function is now self-contained and uses the correct helper functions.
    validateAges();

    // --- 1. GATHER ALL INPUTS ---
    const ci = +els.currentInvestment.value || 0;
    const di = +els.desiredIncome.value || 0;
    const mc = +els.monthlyContribution.value || 0;
    const inheritanceAmount = +els.inheritanceAmount.value || 0;
    const inheritanceAge = +els.inheritanceAge.value || 0;
    const cppBenefit = +els.cppBenefit.value || 0;
    const cppStartAge = +els.cppStartAge.value || 65;
    const inf = +els.inflationRate.value / 100 || 0;
    const pre = +els.preReturn.value / 100 || 0;
    const post = +els.postReturn.value / 100 || 0;
    const sa = +els.startAge.value,
          ra = +els.retireAge.value;
    let ea = +els.endAge.value;
    const stopAge = +els.stopAge.value || ra;
    const yrsTo = ra - sa;
    const mRate = pre / 12;
    const months = yrsTo * 12;
    const showFuture = document.getElementById("finDisplayToggle").checked;
    const drawdownType = document.getElementById("drawdownToggle").checked ? "perpetual" : "finite";

    if (drawdownType === 'perpetual') {
        ea = 120; // Use a long fixed end age for perpetual mode
    }

    // --- 2. PERFORM CORE CALCULATIONS (using helpers) ---
    const fin = calculateRealFIN(di, cppBenefit, cppStartAge, sa, ra, ea, inf, post);
    const fvOfCurrentPlan = simulateAccumulation(ci, mc, stopAge, sa, ra, mRate, inheritanceAmount, inheritanceAge);
    const fullyFundedNow = fin > 0 ? fin / Math.pow(1 + mRate, months) : 0;
    const totalMonthlySavingRequired = fin > 0 ? (mRate > 0 ? fin * mRate / (Math.pow(1 + mRate, months) - 1) : fin / months) : 0;

    // --- 3. UPDATE UI WIDGETS ---
    if (showFuture) {
        els.finAmount.textContent = '$' + fin.toLocaleString(undefined, { maximumFractionDigits: 0 });
    } else {
        const finTodaysDollars = fin / Math.pow(1 + inf, yrsTo);
        els.finAmount.textContent = '$' + finTodaysDollars.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    document.getElementById("fullyFundedNow").textContent = '$' + Math.max(0, fullyFundedNow - ci).toLocaleString(undefined, { maximumFractionDigits: 0 });
    const rem = Math.max(fin - fvOfCurrentPlan, 0);
    const monthlyNeed = rem > 0 ? (mRate > 0 ? rem * mRate / (Math.pow(1 + mRate, months) - 1) : rem / months) : 0;
    els.monthlyNeeded.textContent = '$' + monthlyNeed.toLocaleString(undefined, { maximumFractionDigits: 0 });
    const futureMonthlyIncome = di * Math.pow(1 + inf, yrsTo);
    document.getElementById('futureIncomeDisplay').value = futureMonthlyIncome.toLocaleString(undefined, { maximumFractionDigits: 0 });
    const fvCurr = ci * Math.pow(1 + mRate, months);
    const fvCont = mRate > 0 ? mc * ((Math.pow(1 + mRate, months) - 1) / mRate) * (1 + mRate) : mc * months;
    document.getElementById("futureValueInvestmentDisplay").value = fvCurr.toLocaleString(undefined, { maximumFractionDigits: 0 });
    document.getElementById("futureValueContributionDisplay").value = fvCont.toLocaleString(undefined, { maximumFractionDigits: 0 });
    document.getElementById("incomeProtectionNumber").textContent = `$${(di * 12 * 12).toLocaleString(undefined, {maximumFractionDigits:0})}`;
    autoscaleInputs();

    // --- 4. PREPARE CHART & TABLE DATA ---
    const targetMap = new Map();
    const currentMap = new Map();

    // Target Plan Accumulation (Starts at 0, uses total required savings)
    let balTarget = 0;
    for (let age = sa; age < ra; age++) {
        targetMap.set(age, balTarget);
        for (let month = 1; month <= 12; month++) {
            balTarget = (balTarget + totalMonthlySavingRequired) * (1 + mRate);
        }
    }
    
    // Current Plan Accumulation
    let balCurrent = ci;
    for (let age = sa; age < ra; age++) {
        currentMap.set(age, balCurrent);
        if (inheritanceAge > 0 && age === inheritanceAge) { balCurrent += inheritanceAmount; }
        for (let month = 1; month <= 12; month++) {
            balCurrent = (balCurrent + (age < stopAge ? mc : 0)) * (1 + mRate);
        }
    }

    // Drawdown Phase Data
    const targetDrawdownData = simulateDrawdown(fin, di, cppBenefit, cppStartAge, sa, ra, ea, inf, post);
    const currentDrawdownData = simulateDrawdown(fvOfCurrentPlan, di, cppBenefit, cppStartAge, sa, ra, ea, inf, post);
    targetDrawdownData.forEach(d => targetMap.set(d.age, d.balance));
    currentDrawdownData.forEach(d => currentMap.set(d.age, d.balance));
    
    // --- 5. RENDER CHART (with ANNOTATIONS) ---
    const factor = (age) => showFuture ? 1 : Math.pow(1 + inf, age - sa);
    const endOfChart = drawdownType === 'perpetual' ? 100 : ea;
    const allAges = Array.from({length: ea - sa + 1}, (_, i) => sa + i);
    const chartLabels = allAges.filter(age => age <= endOfChart);
    
    finChart.data.labels = chartLabels;
    finChart.data.datasets[0].data = chartLabels.map(age => (targetMap.get(age) || 0) / factor(age));
    finChart.data.datasets[1].data = chartLabels.map(age => (currentMap.get(age) || 0) / factor(age));

    const isDark = document.body.classList.contains('dark');
    const annotationLabelBg = isDark ? 'rgba(68, 68, 68, 0.9)' : 'rgba(0, 0, 0, 0.7)';
    const annotationLabelColor = '#fff';
    finChart.options.plugins.annotation.annotations = {
        startAgeLine: { type: 'line', xMin: sa, xMax: sa, borderColor: 'green', borderDash: [6, 6], borderWidth: 2, label: { content: 'Start Age', enabled: true, position: {x:'center', y:'end'}, yAdjust: 8, backgroundColor: annotationLabelBg, color: annotationLabelColor }},
        retireAgeLine: { type: 'line', xMin: ra, xMax: ra, borderColor: 'blue', borderDash: [6, 6], borderWidth: 2, label: { content: 'Retire Age', enabled: true, position: {x:'center', y:'end'}, yAdjust: 8, xAdjust: -14, backgroundColor: annotationLabelBg, color: annotationLabelColor }},
        endAgeLine: { type: 'line', xMin: ea, xMax: ea, borderColor: 'red', borderDash: [6, 6], borderWidth: 2, label: { content: 'Life Expectancy', enabled: true, position: 'start', yAdjust: -20, backgroundColor: annotationLabelBg, color: annotationLabelColor }}
    };
    
    // --- 6. RENDER TABLE & UPDATE COLORS ---
    let tableHTML = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#1a73e8;color:#fff;"><th style="padding:8px;">Age</th><th style="padding:8px;">Target Plan ($)</th><th style="padding:8px;">Current Plan ($)</th></tr></thead><tbody>';
    const zeroAge = allAges.find(age => currentMap.get(age) <= 1 && age >= ra);
    const finalFiveStartAge = zeroAge ? Math.max(ra, zeroAge - 5) : null;
    
    chartLabels.forEach(age => {
        let showRow = (age - sa) % 5 === 0 || age === sa || age === ra || age === ea || (finalFiveStartAge && age >= finalFiveStartAge && age <= zeroAge);
        if (!showRow) return;

        const tp = targetMap.get(age) / factor(age);
        const cp = currentMap.get(age) / factor(age);
        
        let rowClass = (age === ra) ? 'retirement-row' : '';
        if (age === ra && fvOfCurrentPlan >= fin) {
            rowClass += ' on-track-green';
        }
        
        tableHTML += `<tr class="${rowClass}"><td style="padding:8px;text-align:center;">${age}</td><td style="padding:8px;text-align:right;">$${(tp || 0).toLocaleString(undefined, {maximumFractionDigits:0})}</td><td style="padding:8px;text-align:right;">$${(cp || 0).toLocaleString(undefined, {maximumFractionDigits:0})}</td></tr>`;
    });
    tableHTML += '</tbody></table>';
    document.getElementById("tableView").innerHTML = tableHTML;
    
    isCurrentPlanSuccessful = fvOfCurrentPlan >= fin && currentMap.get(ea) > 0;
    updateChartColors();
    saveSettings();
}



      [['inflationRate','inflationRateText'],
       ['preReturn','preReturnText'],
       ['postReturn','postReturnText'],
       ['startAge','startAgeText'],
       ['retireAge','retireAgeText'],
       ['stopAge', 'stopAgeText'], 
       ['endAge','endAgeText']].forEach(pair=>{
        const [sl,tx]=pair, slider=els[sl], text=els[tx];
        slider.addEventListener('input',()=>{
          const whole=Math.round(slider.value);
          slider.value=whole;
          text.value=whole;
          calculateFIN();
        });
        text.addEventListener('change',()=>{
          let v=parseFloat(text.value);
          if(isNaN(v)) v=+slider.min;
          slider.value=Math.min(Math.max(v,+slider.min),+slider.max);
          text.value=slider.value;
          calculateFIN();
        });
      });
let debounceTimeout;
document.querySelectorAll('input[type="number"]').forEach(inp => {
  inp.addEventListener('input', () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      calculateFIN();
    }, 300); // 300ms debounce
  });
});

      function exportPDF(){
        html2pdf().set({margin:0.5,filename:'FIN_tool.pdf',
          image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},
          jsPDF:{unit:'in',format:'letter'}}).from(document.body).save();
      }

      function resetDefaults(){
  localStorage.removeItem('finToolSettings');
  els.currentInvestment.value=0;
  els.desiredIncome.value=2000;
  els.monthlyContribution.value=100;
   els.cppBenefit.value=0;
   els.cppStartAge.value=65;
  els.stopAge.value=65; els.stopAgeText.value=65;
  els.inheritanceAmount.value=0;
  els.inheritanceAge.value=0;
  els.inflationRate.value=2; els.inflationRateText.value=2;
  els.preReturn.value=9; els.preReturnText.value=9;
  els.postReturn.value=7; els.postReturnText.value=7;
  els.startAge.value=25; els.startAgeText.value=25;
  els.retireAge.value=65; els.retireAgeText.value=65;
  els.endAge.value=85; els.endAgeText.value=85;
  els.ageWarning.style.display='none';
  calculateFIN();
}

      function downloadHTML(){
        const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='TeamCanada_FIN_Tool_v1.9.html';
        a.textContent='Download your FIN Tool';
        a.style.display='block'; a.style.margin='20px auto'; a.style.color='#1565c0'; a.style.textAlign='center';
        document.getElementById('downloadLinkContainer').innerHTML=''; document.getElementById('downloadLinkContainer').appendChild(a);
        window.scrollTo(0,document.body.scrollHeight);
      }

      // Initial load
      loadSettings();
      // Set correct label on toggle
const drawdownInitial = document.getElementById("drawdownToggle").checked;
document.getElementById("modeLabel").textContent = drawdownInitial ? "Forever (FIRE style)" : "Life Expectancy";

      calculateFIN();

      // FINAL FIX â€” expose functions to window so buttons work:
      window.exportPDF = exportPDF;
      window.resetDefaults = resetDefaults;
      window.downloadHTML = downloadHTML;

    });

  </script>
  <script>
function autoscaleInputs() {
  const inputs = document.querySelectorAll('.autoscale');
  inputs.forEach(input => {
    const maxWidth = input.clientWidth;


    const testSpan = document.createElement('span');
    const computed = window.getComputedStyle(input);

    // ğŸ§  Clone exact font styling from input
    testSpan.style.visibility = 'hidden';
    testSpan.style.position = 'absolute';
    testSpan.style.whiteSpace = 'nowrap';

    testSpan.style.fontFamily = computed.fontFamily;
    testSpan.style.fontWeight = computed.fontWeight;
    testSpan.style.letterSpacing = computed.letterSpacing;
    testSpan.style.fontStyle = computed.fontStyle;
    testSpan.style.padding = computed.padding;
    testSpan.style.border = computed.border;
    testSpan.style.boxSizing = computed.boxSizing;

    const maxFontSize = 18;
    const minFontSize = 6;
    let fontSize = maxFontSize;

    testSpan.textContent = input.value;
    testSpan.style.fontSize = fontSize + 'px';
    document.body.appendChild(testSpan);

    while ((testSpan.offsetWidth + 1) > maxWidth && fontSize > minFontSize) {
      fontSize--;
      testSpan.style.fontSize = fontSize + 'px';
    }

    input.style.fontSize = fontSize + 'px';
    document.body.removeChild(testSpan);

    // Optional: Show full value on hover
    input.title = input.value;
  });
}

// âœ… Run initially and keep rechecking every 500ms
document.addEventListener('DOMContentLoaded', () => {
  autoscaleInputs();
  setInterval(autoscaleInputs, 500);
});
</script>

<!-- tooltip tippy-->
<script>
  function applyTippyTheme() {
    const tippyTheme = document.body.classList.contains('dark') ? 'dark' : 'light';

    tippy('[data-tooltip]', {
      content(reference) {
        return reference.getAttribute('data-tooltip');
      },
      theme: tippyTheme,
      placement: 'top',
      maxWidth: 240,
      allowHTML: true,
      animation: 'shift-away',
      delay: [100, 100],
      offset: [0, 10],
      inlinePositioning: true,
      popperOptions: {
        modifiers: [
          {
            name: 'preventOverflow',
            options: {
              boundary: 'window'
            }
          }
        ]
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    applyTippyTheme();

    const observer = new MutationObserver(() => {
      document.querySelectorAll('[data-tippy-root]').forEach(el => el.remove());
      applyTippyTheme();
    });

    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  });
</script>




<script>
  // This script creates a small box to display the window width.
  const widthDisplay = document.createElement('div');
  widthDisplay.style.position = 'fixed';
  widthDisplay.style.bottom = '10px';
  widthDisplay.style.right = '10px';
  widthDisplay.style.padding = '5px 10px';
  widthDisplay.style.background = 'rgba(0, 0, 0, 0.7)';
  widthDisplay.style.color = 'white';
  widthDisplay.style.fontFamily = 'sans-serif';
  widthDisplay.style.borderRadius = '5px';
  widthDisplay.style.zIndex = '9999';
  document.body.appendChild(widthDisplay);

  function updateWidth() {
    widthDisplay.textContent = `Width: ${window.innerWidth}px`;
  }

  window.addEventListener('resize', updateWidth);
  updateWidth(); // Show initial width
</script>
<script>


function calcInput(char) {
  if (char === '.' && calcBuffer.split(/[\+\-\*\/]/).pop().includes('.')) return;
  calcBuffer += char;
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcClear() {
  calcBuffer = "";
  document.getElementById('calcDisplay').value = "";
}
function calcBackspace() {
  calcBuffer = calcBuffer.slice(0, -1);
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcEquals() {
  try {
    if (/^[0-9+\-*/.() ]+$/.test(calcBuffer)) {
      let result = eval(calcBuffer);
      document.getElementById('calcDisplay').value = result;
      calcBuffer = String(result);
    } else {
      document.getElementById('calcDisplay').value = "Err";
      calcBuffer = "";
    }
  } catch {
    document.getElementById('calcDisplay').value = "Err";
    calcBuffer = "";
  }
}

document.addEventListener('keydown', function (e) {
  const isCalcVisible = !document.getElementById('basicCalculator').classList.contains('hidden');
  if (!isCalcVisible) return;

  const key = e.key;

  if (/\d/.test(key)) {
    calcInput(key); // numbers 0â€“9
  } else if (key === '+' || key === '-' || key === '*' || key === '/' || key === '.') {
    calcInput(key);
  } else if (key === 'Enter' || key === '=') {
    e.preventDefault(); // prevent form submission if any
    calcEquals();
  } else if (key === 'Backspace') {
    e.preventDefault();
    calcBackspace();
  } else if (key === 'Escape') {
    calcClear();
  }
});

</script>

<script>
(function () {
  const el = document.getElementById("basicCalculator");
  const handle = document.getElementById("calcDragHandle");
  let offsetX = 0, offsetY = 0, isDragging = false;

  // Restore position if saved
  const savedLeft = localStorage.getItem("calcLeft");
  const savedTop = localStorage.getItem("calcTop");

  if (savedLeft !== null && savedTop !== null) {
    el.style.left = savedLeft + "px";
    el.style.top = savedTop + "px";
    el.style.right = ""; // Clear right to avoid layout conflict
  }

  function startDrag(x, y) {
    isDragging = true;
    offsetX = x - el.offsetLeft;
    offsetY = y - el.offsetTop;
    el.style.position = "fixed";
    document.body.style.userSelect = "none";
  }

  function dragTo(x, y) {
    if (!isDragging) return;
    const left = x - offsetX;
    const top = y - offsetY;
    el.style.left = `${left}px`;
    el.style.top = `${top}px`;
    el.style.right = ""; // Clear right so left takes effect
    localStorage.setItem("calcLeft", left);
    localStorage.setItem("calcTop", top);
  }

  function stopDrag() {
    isDragging = false;
    document.body.style.userSelect = "";
  }

  // Mouse events
  handle.addEventListener("mousedown", e => startDrag(e.clientX, e.clientY));
  document.addEventListener("mousemove", e => dragTo(e.clientX, e.clientY));
  document.addEventListener("mouseup", stopDrag);

  // Touch events
  handle.addEventListener("touchstart", e => {
    const touch = e.touches[0];
    startDrag(touch.clientX, touch.clientY);
  }, { passive: false });

  document.addEventListener("touchmove", e => {
    if (!isDragging) return;
    const touch = e.touches[0];
    dragTo(touch.clientX, touch.clientY);
  }, { passive: false });

  document.addEventListener("touchend", stopDrag);
})();
</script>


<script>
  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      
      // Switch active tab
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Show selected tab, hide others
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById('tab-' + tab).classList.remove('hidden');
    });
  });
  

</script>

<!-- Right-Side Menu Button -->
<button id="menuToggleBtn"
  style="position: fixed; top: 48px; right: 20px; z-index: 999;
         background: none; border: none; padding: 0; cursor: pointer;">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 80" width="40" height="40" fill="#1976d2">
    <rect width="100" height="15"></rect>
    <rect y="30" width="100" height="15"></rect>
    <rect y="60" width="100" height="15"></rect>
  </svg>
</button>

<!-- Slide-Out Menu Overlay -->
<div id="sideMenuOverlay" class="side-menu hidden">

  <!-- Header -->
  <div class="side-menu-header">
    <span><strong>Menu</strong></span>
    <button id="closeMenuBtn">âœ–</button>
  </div>

  <!-- Section 1: Global Toggles -->
  <div class="side-menu-section">
    <h4>Settings</h4>

    <!-- ğŸŒ™ Dark Mode -->
    <div class="toggle-row tooltip-container" data-tooltip="Enable dark theme for the entire tool.">
      <label class="switch">
        <input type="checkbox" id="darkModeToggle" />
        <span class="slider"></span>
      </label>
      <label for="darkModeToggle"> Dark Mode</label>
    </div>

    <!-- ğŸ“ˆ Future $ -->
    <div class="toggle-row tooltip-container" data-tooltip="Toggle between inflation-adjusted and todayâ€™s dollar view. Generally you will want to use the Future $ adjusted by inflation as in reality we experience inflation and what things cost today will not be the case in the future. The longer we have before we will be using that money, the more inflation will play a critical role">
      <label class="switch">
        <input type="checkbox" id="finDisplayToggle" />
        <span class="slider"></span>
      </label>
      <label id="finDisplayLabel" for="finDisplayToggle"> Future $</label>
    </div>

    <!-- â™¾ï¸ Forever -->
    <div class="toggle-row tooltip-container" data-tooltip="Switch between perpetual withdrawal mode and life expectancy-based planning. Forever mode means money will never run out provided the growth remains constant. Life expectancy mode means we only need money until the year we die, after that we expect to have zero in our investments.">
      <label class="switch">
        <input type="checkbox" id="drawdownToggle" />
        <span class="slider"></span>
      </label>
      <label id="modeLabel" for="drawdownToggle"> Forever Mode</label>
    </div>
  </div>

  <!-- Section 2: Tabs -->
  <div class="side-menu-section">
    <h4>Show Tabs</h4>

    <!-- Master Toggle -->
    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggleAllTabs" />
        <span class="slider"></span>
      </label>
      <label for="toggleAllTabs">Show All Tabs</label>
    </div>

    <!-- Individual Tab Toggles -->
    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-rdsp" data-toggle-tab="rdsp" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-rdsp">Show RDSP</label>
    </div>

    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-resp" data-toggle-tab="resp" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-resp">Show RESP</label>
    </div>

    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-tfsa" data-toggle-tab="tfsa" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-tfsa">Show TFSA / RRSP</label>
    </div>

    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-btid" data-toggle-tab="btid" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-btid">Show BTID vs WL</label>
    </div>

    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-tax" data-toggle-tab="tax" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-tax">Show Income Tax Calculator</label>
    </div>

    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-budget" data-toggle-tab="budget" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-budget">Show Budgeting</label>
    </div>

    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggle-fna" data-toggle-tab="fna" checked />
        <span class="slider"></span>
      </label>
      <label for="toggle-fna">Show FNA</label>
    </div>

  </div>
</div>


<div id="helpOverlay" class="help-overlay">
  <div class="help-box">
    <h2>Help & Shortcuts</h2>
    <ul>
      <li><strong>Ctrl + Alt + M</strong> â€” Toggle Side Menu</li>
      <li><strong>Ctrl + Alt + C</strong> â€” Open Calculator</li>
      <li><strong>Ctrl + Alt + L</strong> â€” Toggle Dark Mode</li>
      <li><strong>Ctrl + Alt + R</strong> â€” Reset Inputs</li>
      <li><strong>Ctrl + Alt + /</strong> â€” Show/Hide This Help</li>
    </ul>
    <hr>
    <p>Need help? Contact: <a href="mailto:dmitri.ivanenko@gmail.com">dmitri.ivanenko@gmail.com</a></p>
    <button onclick="toggleHelpOverlay()">Close</button>
  </div>
</div>
<script>
//helper yellow bar below the tabs
  document.addEventListener('DOMContentLoaded', () => {
    const hint = document.getElementById('shortcutHint');
    if (!hint) return;

    let hideTimer;
    let idleTimer;
    let wasAutoShown = false;

    const hideHint = () => {
      hint.classList.add('fade-out');
      setTimeout(() => hint.classList.add('hidden'), 600);
    };

    const showHint = (auto = false) => {
      hint.classList.remove('fade-out', 'hidden');
      if (!auto) {
        // only set 10s hide timer on first/manual show
        clearTimeout(hideTimer);
        hideTimer = setTimeout(hideHint, 10000);
      } else {
        wasAutoShown = true;
      }
    };

    const resetIdleTimer = () => {
      clearTimeout(idleTimer);

      // If user moves & hint was auto-shown, hide it again
      if (wasAutoShown) {
        wasAutoShown = false;
        hideHint();
      }

      idleTimer = setTimeout(() => {
        showHint(true); // auto = true: don't set hide timer
      }, 300000); // idle for 300s
    };

    // Initial show + hide after 10s
    showHint();
    hideTimer = setTimeout(hideHint, 10000);

    // Activity resets idle
    ['mousemove', 'keydown', 'touchstart', 'click'].forEach(evt => {
      document.addEventListener(evt, resetIdleTimer, { passive: true });
    });

    resetIdleTimer(); // Start idle tracking
  });
</script>





<script src="js/loader.js"></script>

</body>

</html>
