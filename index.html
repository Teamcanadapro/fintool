<!DOCTYPE html>
<html lang="en">
<head>
	
	
	<!--
Copyright ¬© 2025 Dmitri Ivanenko, Team Canada Financial Tool. All Rights Reserved.
Created by Dmitri Ivanenko, June 10, 2025 (initial)
This tool is provided for personal use only.
No part of the source code, design, or content may be copied, reproduced, modified, or redistributed without prior written permission.
-->
	
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team Canada FIN Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1"></script>
<script>
  Chart.register(window['chartjs-plugin-annotation']);
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
<link rel="icon" type="image/x-icon" href="./favicon_io/favicon.ico?v=20250804">
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

  
<style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',sans-serif;background:#f4f7fb;color:#222;display:flex;flex-direction:column;align-items:center;padding:20px;}
    h1,h2{color:#1a73e8;margin-bottom:8px;}
    .version,.last-updated{font-size:.85rem;color:#555;margin-bottom:16px;}
    .inputs-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  width: 100%;
  max-width: 520px; /* changed from 900px */
  box-sizing: border-box; /* recommended */
}

    .input-group, .slider-group {
  padding: 12px;
  border-radius: 8px;
}

/* üî• Light Mode Styling (default if NOT dark) */
body:not(.dark) .input-group,
body:not(.dark) .slider-group {
  background-color: #f9f9fc;
  border: 1px solid #bbb;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

    label{display:block;margin-bottom:6px;font-weight:600;}
    input[type=number],input[type=text],input[type=range]{font-size:1rem;}
    input[type=number],input[type=text]{width:100%;padding:6px;margin-bottom:4px;border:1px solid #aaa;border-radius:4px;}
    .slider-container{display:flex;align-items:center;gap:8px;}
    .output{font-size:1.2rem;font-weight:600;margin:16px 0;text-align:center;}
#finChart{
  display:block;
  width:100%;
  max-width:none;      /* no cap */
  height:auto;         /* base height; expanded CSS will set real height */
  background:#fff;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}



    .buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:20px;}
    .btn{padding:10px 20px;font-size:1rem;color:#fff;border:none;border-radius:4px;cursor:pointer;}
    .btn-red{background:#d32f2f;} .btn-red:hover{background:#b71c1c;}
    .btn-blue{background:#1976d2;} .btn-blue:hover{background:#0d47a1;}
    .btn-green{background:#388e3c;} .btn-green:hover{background:#1b5e20;}
    #ageWarning{color:#d84315;text-align:center;margin-bottom:10px;display:none;}
    @media print{.btn,.buttons,.last-updated{display:none;}body{padding:0;background:none;}}
 
.switch {
  position: relative;
  display: inline-block;
  width: 30px;
  height: 12px;
  margin-top: 4px;
}


.switch input { display: none; }

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #4caf50;
}

input:checked + .slider:before {
  transform: translateX(18px);
}

.version-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9em;
  margin-bottom: 10px;
}

.version,
.last-updated {
  margin-right: 15px;
  white-space: nowrap;
}


.inputs-container,
.results-container {
  flex: 1 1 400px;
  max-width: 480px;
}

.graph-container {
  flex: 1 1 auto;
  min-width: 300px;
  width: 100%;
  padding: 0 0 10px;
  box-sizing: border-box;
}


.main-wrapper {
  display: flex;
  justify-content: center;
  width: 100%;
}

.fin-toggle-centered {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}


@media (min-width: 540px) {
  .main-layout {
    flex-direction: row;
  }

 .left-column,
.inputs-container {
  flex: 1 1 480px;
  min-width: 240px;
  max-width: 520px;
}

.inputs-container {
  margin-top: 0px;
}

}


body.dark {
  background: #121212;
  color: #eee;
}

body.dark .input-group,
body.dark .slider-group,
body.dark .results-container,
body.dark .graph-container,
body.dark .buttons {
  background: #1e1e1e;
  color: #eee;
}

body.dark input[type=number],
body.dark input[type=text],
body.dark input[type=range] {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #444;
}

body.dark .btn-red,
body.dark .btn-blue,
body.dark .btn-green {
  opacity: 0.9;
}

body.dark table {
  color: #ddd;
}

body.dark th {
  background: #333;
}

body.dark td {
  background: #1e1e1e;
}


.header-title {
  font-size: 1.8rem;
  color: #007bff;
  margin: 0;
  white-space: nowrap;  /* ‚õî Prevents line break */
}


.dark-mode-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95rem;
}


.highlight-success {
  color: #3df283;
  font-weight: bold;
}

.info-icon {
  margin-left: 6px;
  cursor: help;
  font-size: 14px;
  color: #aaa;
}
.info-icon:hover {
  color: #fff;
}

.tooltip-container {
  position: relative;
  display: inline-block;
  
  overflow: visible;
}
.tooltip-container::after {
  content: none !important;
}


.tooltip-text {
  font-weight: normal;
  visibility: hidden;
  opacity: 0;
  background-color: #fff8b3;
  color: #222;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #e0c300;
  position: absolute;
  top: 100%; /* ‚¨áÔ∏è show below the element */
  left: 50%;
  transform: translateX(-50%) translateY(6px);
  z-index: 100;
  transition: opacity 0.2s ease, transform 0.2s ease;
  white-space: normal;
  max-width: 250px;
  width: max-content;
  word-wrap: break-word;
  box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
  text-align: center;
}

.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
  transform: translateX(-50%) translateY(10px);
}
.summary-box {
  background-color: var(--card-bg, #fff);
  color: var(--text-color, #000);
  padding: 20px 24px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 0.95rem;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, auto);
  gap: 24px 48px; /* vertical gap 24px, horizontal gap 48px */
}

.summary-header {
  display: contents; /* lets summary-box handle grid */
}

.output {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  white-space: nowrap;
  padding: 0;
}

.label-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 6px;
}

.icon {
  font-size: 1.3rem;
  line-height: 1;
}

.output strong {
  font-size: 1.4rem;
  color: #007bff;
  font-weight: 700;
  white-space: nowrap;
}

/* Tooltip styles can remain as is, or add margin if needed */
.tooltip-text {
  font-weight: normal;
  font-size: 0.85rem;
  max-width: 260px;
  margin-top: 6px;
  color: #444;
}

/* Dark mode */
body.dark .summary-box {
  background-color: #1a1a1a;
  color: #eee;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

body.dark .output strong {
  color: #3399ff;
}

body.dark .tooltip-text {
  background-color: #444c00;  /* darker yellow/olive */
  color: #fff;                /* white text for contrast */
  border-color: #666600;      /* darker border to match */
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.8); /* subtle shadow for legibility */
}



/* Only applied when .debug-layout is on <body> */
.debug-layout .main-layout {
  outline: 2px dashed #444;
  position: relative;
}

.debug-layout .left-column {
  background-color: rgba(0, 128, 255, 0.05);
  border: 1px solid rgba(0, 128, 255, 0.2);
  position: relative;
}

.debug-layout .inputs-container {
  background-color: rgba(255, 128, 0, 0.05);
  border: 1px solid rgba(255, 128, 0, 0.2);
  position: relative;
}

.debug-layout .left-column::before,
.debug-layout .inputs-container::before {
  content: attr(class);
  position: absolute;
  top: -1.5em;
  font-size: 12px;
  font-family: monospace;
  background: #222;
  color: #0f0;
  padding: 2px 6px;
  border-radius: 4px;
}

.main-layout {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: flex-start;
  gap: 10px;
  width: 100%;
  max-width: 1600px;
  margin: 0 auto;
  box-sizing: border-box;
}

.middle-column {
  flex: 1 1 580px;
  min-width: 320px;
  max-width: 700px;
}

.main-layout.chart-is-expanded .middle-column {
  max-width: none;
}

.right-column {
  flex: 0 1 340px;
  max-width: 400px;
  min-width: 240px;
}




@media (max-width: 768px) {
  .main-layout {
    flex-direction: row;
    row-gap: 10px; /* Adjust this value to your liking, or set to 0 to remove the gap completely */
  }


  .inputs-container {
    margin-top: 0px;
  }

  /* Reduces side padding on the whole page */
  body {
    padding: 10px;
  }
}



.fin-toggle {
  display: inline-flex;
  align-items: center;
  margin-right: 12px;
  min-width: 150px; /* ‚¨ÖÔ∏è Keep toggles equally spaced */
  justify-content: space-between;
}

.fin-toggle label {
  margin-right: 8px;
  white-space: nowrap;
}


.toggle-item {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 200px;
  white-space: nowrap;
  justify-content: center;
}

#scenario-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);  /* üß± 4 equal columns */
  gap: 10px;
  max-width: 100%;
  margin: 12px auto;
  padding: 0 10px;
}



/* üîÅ Base (dark mode default) */
.scenario-btn {
  background-color: #444;
  color: white;
  border: 1px solid #888;
  padding: 8px 12px;
  font-size: 14px;
  font-weight: bold;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s;
}

.scenario-btn.active {
  background-color: #0094ff;
  border-color: #0094ff;
}


.scenario-btn:hover {
  background-color: #666;
}

/* --- Modern Light Mode Scenario Buttons --- */

/* Default (Inactive) Button Style in Light Mode */
body:not(.dark) .scenario-btn {
  background-color: #ffffff;    /* Clean white background */
  color: #1976d2;             /* Use primary blue for text */
  border: 1px solid #dadce0;     /* Soft, modern gray border */
  font-weight: 600;              /* Slightly bolder text */
}

/* Hover State for Inactive Buttons in Light Mode */
body:not(.dark) .scenario-btn:not(.active):hover {
  background-color: #f8fbff;    /* A very subtle light blue glow */
  border-color: #cce0fc;         /* A slightly stronger blue border */
}

/* Active Button Style in Light Mode */
body:not(.dark) .scenario-btn.active {
  background-color: #1976d2;    /* Solid primary blue background */
  color: #ffffff;                /* White text for contrast */
  border-color: #1976d2;         /* Matching solid blue border */
}

/* --- Modern Expand Button --- */
.graph-expand-btn {
  /* Positioning and Shape */
  display: block;
  text-align: center;
  width: -moz-fit-content;
  width: fit-content;
  margin: 12px auto 0; /* Centers the button horizontally */
  padding: 6px 16px;
  border-radius: 99px; /* Creates the pill shape */
  
  /* Font and Appearance */
  font-size: 0.8rem; /* 13px */
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

/* Light Mode Colors */
body:not(.dark) .graph-expand-btn {
  background-color: #f1f3f4;
  color: #3c4043;
}

/* Dark Mode Colors */
body.dark .graph-expand-btn {
  background-color: #3c4043;
  color: #e8eaed;
}

/* Hover Effect */
.graph-expand-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

body.dark .graph-expand-btn:hover {
   box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}


#futureIncomeDisplay {
  background: #f0f0f0;
  color: #000;
  border: 1px solid #ccc;
}

body.dark #futureIncomeDisplay {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #555;
}
.readonly-box {
  background: #f0f0f0;
  color: #000;
  border: 1px solid #ccc;
  border-radius: 4px;

  box-sizing: border-box;
  padding: 2px 4px;

  text-align: left;
  white-space: nowrap;

  font-size: 1rem; 
  line-height: 1.2;

  width: 100%;
  min-width: 0;
  max-width: 100%;

  overflow: hidden; /* ‚úÖ stops scrollbars if value is still too large momentarily */
}





body.dark .readonly-box {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #555;
}

.autoscale {
  font-size: 1.2rem;
  transition: font-size 0.2s ease;
}

.header-layout {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
}


.header-flex {
  display: flex;
  justify-content: space-between;
  align-items: center;  /* ‚úÖ now centers vertically */
  flex-wrap: wrap;
  gap: 16px;
  max-width: 1100px;
  margin: 0 auto 10px auto;
}
@media (max-width: 600px) {
  .header-flex {
    flex-direction: column;
    align-items: center;
  }
}

.header-left {
  display: flex;
  flex-direction: column;
  justify-content: center;
  flex: 1;
}

@media (max-width: 600px) {
  .header-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .header-title {
    margin-bottom: 2px;
  }
}
.header-center {
  flex-grow: 1;
  display: flex;
  justify-content: flex-end;  /* üëà pushes toggles to the right */
}
.toggle-bar {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  align-items: center;
}

@media (max-width: 600px) {
  .toggle-bar {
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }

  .toggle-item {
    font-size: 13px;
    flex: 1 1 30%;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .switch {
    transform: scale(0.75);
  }
}

.version-info {
  font-size: 0.65rem;  /* smaller font size */
  opacity: 0.75;
  margin-top: 4px;     /* a little space below the title */
  white-space: nowrap; /* prevent wrapping */
}
#tableSection {
  margin-top: 20px;
  background: var(--card-bg, #fff);
  color: var(--text-color, #000);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 0.9rem;
  max-width: 900px;
  padding: 0;
}

#tableHeader {
  cursor: pointer;
  padding: 14px 20px;
  font-weight: 700;
  font-size: 1.2rem;
  user-select: none;
  background: #007bff;
  color: white;
  border-radius: 8px 8px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}


/* Dark mode */
body.dark #tableSection {
  background: #1a1a1a;
  color: #eee;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

body.dark #tableHeader {
  background: #3399ff;
  color: #eee;
}

body.dark #tableContent {
  background: #222;
}
#tableContent {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease;
}

#tableContent.open {
  max-height: 1500px;
}


body.debug-layout .header-flex,
body.debug-layout .main-wrapper,
body.debug-layout .main-layout,
body.debug-layout .header-flex,
body.debug-layout .header-left,        /* ‚¨ÖÔ∏è ADD THIS */
body.debug-layout .main-wrapper,
body.debug-layout .left-column,
body.debug-layout .middle-column,
body.debug-layout .right-column,
body.debug-layout .inputs-container,
body.debug-layout .graph-container,
body.debug-layout .summary-bar,
body.debug-layout .summary-box,
body.debug-layout .graph-modal-content,
body.debug-layout #scenario-row,
body.debug-layout #faq,
body.debug-layout #tableView {
  position: relative;
}

body.debug-layout .header-flex::before,
body.debug-layout .header-flex::before,
body.debug-layout .header-left::before, /* ‚¨ÖÔ∏è ADD THIS */
body.debug-layout .main-wrapper::before,
body.debug-layout .main-wrapper::before,
body.debug-layout .main-layout::before,
body.debug-layout .left-column::before,
body.debug-layout .middle-column::before,
body.debug-layout .right-column::before,
body.debug-layout .inputs-container::before,
body.debug-layout .graph-container::before,
body.debug-layout .summary-bar::before,
body.debug-layout .summary-box::before,
body.debug-layout .graph-modal-content::before,
body.debug-layout #scenario-row::before,
body.debug-layout #faq::before,
body.debug-layout #tableView::before {
  content: attr(class);
  position: absolute;
  top: -1.5em;
  left: 0;
  font-size: 12px;
  font-family: monospace;
  background: #222;
  color: #0f0;
  padding: 2px 6px;
  border-radius: 4px;
  z-index: 1000;
}

/* Light Theme */
.tippy-box[data-theme~='light'] {
  background-color: #fffbe7;
  color: #222;
  border: 1px solid #e0c300;
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 6px;
  text-align: left;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Dark Theme */
.tippy-box[data-theme~='dark'] {
  background-color: #2e2e2e;
  color: #f8f8a3;
  border: 1px solid #888800;
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 6px;
  text-align: left;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}

#tableView table tbody tr:nth-child(even) {
  background-color: #e9f1fb; /* Soft sky blue for better contrast */
}

body.dark #tableView table tbody tr:nth-child(even) {
  background-color: #1f1f1f; /* a notch lighter than pure black */
}

#tableView table td {
  border-bottom: 1px solid #ccc;
}

body.dark #tableView table td {
  border-bottom: 1px solid #444;
}

#tableView table .retirement-row {
  background-color: #fff9db !important; /* Light golden highlight */
  font-weight: 600;
}

body.dark #tableView table .retirement-row td {
  background-color: #5c4500 !important; /* Deep amber */
  color: #e0f2f1 !important;            /* Warm yellow text */
  font-weight: 600;
}

#tableView table .on-track-green {
  background-color: #c8facc !important; /* Pale green for light mode */
  color: #006400 !important;            /* Dark green text */
  font-weight: 600;
}

body.dark #tableView table .on-track-green td {
  background-color: #006400 !important; /* Toggle-matching teal */
  color: #e0f2f1 !important;            /* Light mint for contrast */
  font-weight: 600;
}
body.dark #tableView table .on-track-green,
body.dark #tableView table .on-track-green td,
body.dark #tableView table td.on-track-green {
  background-color: #006400 !important;
  color: #e0f2f1 !important;
  font-weight: 600;
}





/* --- Final Styles for Expanded Chart (fixed) --- */

.main-layout.chart-is-expanded .middle-column {
  flex: 1;
  height: 70vh;            /* gives a nice tall area */
}

.main-layout.chart-is-expanded .graph-container {
  display: block;
  height: 100%;
  flex-direction: unset;   /* not needed when display:block */
}

.main-layout.chart-is-expanded .right-column {
  display: none;
}

/* Base graph container rules */
.graph-container {
  display: block;
  width: 100%;
  height: auto;
  padding: 0;
  margin: 0 auto;
  padding-bottom: 6px;
}

#finChartContainer {
  display: block;
  width: 100%;
  height: 100%;
}



@media (max-width: 1530px) {
  .main-layout.chart-is-expanded {
    flex-direction: column;
    align-items: center;
  }

  .main-layout.chart-is-expanded .middle-column {
    width: 100%;
    max-width: 100%;
    height: auto;
  }

  .main-layout.chart-is-expanded .graph-container {
    width: 100%;
    height: 60vh;     /* responsive height on narrower screens */
    margin-top: 20px;
  }
}
@media (max-width: 1530px) {
  /* your existing small screen styles */
}

/* Let middle column use all remaining width and reduce the left column width */
.left-column { flex: 0 0 420px; }       /* make inputs a fixed narrower column */
.main-layout.chart-is-expanded .middle-column { max-width: none; flex: 1 1 auto; }
.main-layout.chart-is-expanded .graph-container,
#finChartContainer { width: 100%; height: 70vh; }
#finChart { width: 100% !important; height: 100% !important; }


@media (max-width: 600px) {
  .summary-bar {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: auto auto;
    gap: 20px;
    justify-items: center;
    width: 100%;
  }

  .summary-bar .output {
    width: 100%;
    max-width: 100%;
    min-width: 0;
    text-align: center;
  }
}

.on-track-green {
  background-color: #c7f7c1 !important;
  color: #176a12 !important;
  font-weight: bold;
}
.on-track-green td {
  background-color: #c7f7c1 !important;
  color: #176a12 !important;
}


/* Standardize slider thumb color across devices */
input[type=range] {
  accent-color: #1a73e8; /* For modern Chrome, Edge, Firefox */
}

input[type=range]::-webkit-slider-thumb {
  background-color: #1a73e8;
}

input[type=range]::-moz-range-thumb {
  background-color: #1a73e8;
}

#calcDragHandle {
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
  cursor: grab;
  padding: 10px;
  width: 100%;
}

/* Green highlight for on-track retirement row */
.retirement-row.on-track {
  background-color: #d1f2cc !important;  /* Light green */
  color: #145d19 !important;            /* Dark green text */
}
body.dark .retirement-row.on-track {
  background-color: #2a3f2a !important; /* Darker green for dark mode */
  color: #8fffa1 !important;            /* Light green text */
}

/* --- New Layout for Top Interactive Area --- */

.top-interactive-area {
  display: flex;
  flex-direction: column; /* Mobile First: Stack vertically by default */
  width: 100%;
  max-width: 1100px; /* Match the header width */
  margin: 0 auto;
  gap: 10px;
}

/* On screens wider than 1000px, switch to a side-by-side layout */
@media (min-width: 1000px) {
  .top-interactive-area {
    flex-direction: row; /* Horizontal layout */
    align-items: center; /* Vertically center the items */
    justify-content: space-between;
    gap: 20px;
  }

  #scenario-row {
    flex: 1 1 auto; /* Allow the scenario buttons to grow and fill available space */
    margin: 0;
  }

  .summary-bar {
    flex: 0 0 auto; /* Prevent the summary bar from growing or shrinking */
    margin: 0;
    padding: 12px 20px;
    border-radius: 8px;
    background-color: #f9f9fc;
    border: 1px solid #ddd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  body.dark .summary-bar {
    background-color: #1e1e1e;
    border-color: #444;
  }
}
/* EXPANDED (keep inputs visible) ‚Äî final overrides */
.left-column { flex: 0 0 420px; }                 /* narrower inputs column */

.main-layout.chart-is-expanded .middle-column {
  max-width: none;
  flex: 1 1 auto;
}

.main-layout.chart-is-expanded .graph-container,
.main-layout.chart-is-expanded #finChartContainer {
  display: block !important;
  width: 100% !important;
  height: 70vh !important;
}

.main-layout.chart-is-expanded canvas#finChart {
  width: 100% !important;
  height: 100% !important;
}
/* === Canonical graph container rules === */
.graph-container {
  display: block;          /* full row, not inline-block */
  flex: 1 1 auto;          /* still allowed as a flex child */
  min-width: 300px;
  width: 100%;
  height: auto;
  padding: 0;
  margin: 0 auto;
  padding-bottom: 6px;
  box-sizing: border-box;
}

/* Chart wrapper + canvas fill the container */
#finChartContainer { width: 100%; height: 100%; }
#finChart { width: 100% !important; height: 100% !important; }

/* Expanded: keep inputs visible, give chart vertical space */
.main-layout.chart-is-expanded .graph-container {
  height: 70vh;            /* was 100% ‚Äî that depended on sibling height */
}

/* Narrower screens: a bit shorter */
@media (max-width: 1530px) {
  .main-layout.chart-is-expanded .graph-container {
    height: 60vh;
    margin-top: 20px;
  }
}
/* Keep inputs + chart side‚Äëby‚Äëside when expanded */
.main-layout.chart-is-expanded {
  flex-direction: row;     /* force row */
  flex-wrap: nowrap;       /* do NOT wrap to a new line */
  justify-content: flex-start; /* stop centering that encourages wrap */
  align-items: stretch;
}

/* Fixed width for inputs; chart takes the rest */
.left-column { flex: 0 0 420px; }     /* your chosen inputs width */
.main-layout.chart-is-expanded .middle-column { flex: 1 1 auto; max-width: none; }


 </style>
</head>
<body>
<!-- PASSWORD OVERLAY -->
  <div id="passwordOverlay" style="
    position: fixed; 
    top:0; left:0; right:0; bottom:0; 
    background: #222; 
    color: white; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    z-index: 9999;
  ">
    <label for="passwordInput" style="margin-bottom: 10px; font-size: 1.2rem;">Enter Password:</label>
    <input type="password" id="passwordInput" style="font-size:1rem; padding: 6px;" autocomplete="off" />
    <button id="passwordBtn" style="margin-top: 10px; padding: 8px 16px; font-size:1rem; cursor:pointer;">Submit</button>
    <div id="passwordError" style="color: #f44336; margin-top: 10px; display:none;">Wrong password, try again.</div>
  </div>

  <!-- PAGE CONTENT (initially hidden) -->
  <div id="content" style="display:none;">

<button onclick="document.getElementById('basicCalculator').classList.toggle('hidden')"
  style="position: fixed; top: 20px; left: 20px; z-index: 999;
         background: none; border: none; padding: 0; cursor: pointer;">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
       stroke="#1976d2" stroke-width="4" fill="none"
       style="width: 40px; height: 40px;">
    <!-- Outer calculator body -->
    <rect x="8" y="4" width="48" height="56" rx="6" ry="6"/>
    <!-- Screen area -->
    <rect x="12" y="8" width="40" height="12" rx="2" ry="2"/>
    <!-- Button grid: 3 columns x 3 rows -->
    <circle cx="20" cy="28" r="3"/>
    <circle cx="32" cy="28" r="3"/>
    <circle cx="44" cy="28" r="3"/>
    <circle cx="20" cy="40" r="3"/>
    <circle cx="32" cy="40" r="3"/>
    <circle cx="44" cy="40" r="3"/>
    <circle cx="20" cy="52" r="3"/>
    <circle cx="32" cy="52" r="3"/>
    <circle cx="44" cy="52" r="3"/>
  </svg>
</button>







<!--<body class="debug-layout">-->
<div class="header">

<div class="header-flex">

<div class="header-flex-row" style="display: flex; align-items: flex-start; gap: 20px;">
<!-- Calculator Panel Start -->
<div id="basicCalculator" class="calculator-panel hidden"
style="position: fixed; top: 20px; left: 20px; z-index: 1000;
       max-width: 320px; padding: 16px;
       background: var(--calc-bg, #23272d);
       color: var(--calc-text, #fff);
       border-radius: 14px; box-shadow: 0 2px 8px #0003;">

  <div id="calcDragHandle" style="font-weight:bold;font-size:1.2em;margin-bottom:6px; cursor: move;">Basic Calculator</div>
  
  <!--close button for the draggable calculator-->
  <button onclick="document.getElementById('basicCalculator').classList.add('hidden')"
style="position:absolute; top:10px; right:12px; background:none; color:white; font-size:20px; border:none; cursor:pointer;">√ó</button>

  <input id="calcDisplay" type="text" style="width:100%;padding:10px;font-size:1.3em;margin-bottom:12px;text-align:right;border:none;border-radius:6px;background:var(--calc-panel,#1a1c1e);color:var(--calc-text,#fff);" readonly>
  
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
    <button class="calc-btn" onclick="calcInput('7')">7</button>
    <button class="calc-btn" onclick="calcInput('8')">8</button>
    <button class="calc-btn" onclick="calcInput('9')">9</button>
    <button class="calc-btn" onclick="calcInput('/')">√∑</button>

    <button class="calc-btn" onclick="calcInput('4')">4</button>
    <button class="calc-btn" onclick="calcInput('5')">5</button>
    <button class="calc-btn" onclick="calcInput('6')">6</button>
    <button class="calc-btn" onclick="calcInput('*')">√ó</button>

    <button class="calc-btn" onclick="calcInput('1')">1</button>
    <button class="calc-btn" onclick="calcInput('2')">2</button>
    <button class="calc-btn" onclick="calcInput('3')">3</button>
    <button class="calc-btn" onclick="calcInput('-')">‚àí</button>

    <button class="calc-btn" onclick="calcInput('0')">0</button>
    <button class="calc-btn" onclick="calcInput('.')">.</button>
    <button class="calc-btn" onclick="calcClear()">C</button>
    <button class="calc-btn" onclick="calcInput('+')">+</button>
  </div>

  <!-- Row for equals and backspace -->
  <div style="display:flex;gap:8px;margin-top:12px;">
    <button class="calc-btn" id="calcEquals" style="flex:2;" onclick="calcEquals()">=</button>
    <button class="calc-btn" style="flex:1;" onclick="calcBackspace()">‚å´</button>
  </div>
</div>

<!-- Calculator Styles (copy to your CSS or inside a <style> block) -->
<style>
.hidden {
  display: none !important;
}

:root {
  --calc-bg: #23272d;
  --calc-panel: #1a1c1e;
  --calc-text: #fff;
  --calc-btn-bg: #2a2d34;
  --calc-btn-hover: #1976d2;
  --calc-btn-text: #fff;
  --calc-equals-bg: #1976d2;
}

body:not(.dark) {
  --calc-bg: #f4f5f7;
  --calc-panel: #fff;
  --calc-text: #222;
  --calc-btn-bg: #f0f0f0;
  --calc-btn-hover: #1976d2;
  --calc-btn-text: #222;
  --calc-equals-bg: #1976d2;
}



.calc-btn {
  background: var(--calc-btn-bg, #2a2d34);
  color: var(--calc-btn-text, #fff);
  border: none;
  border-radius: 6px;
  padding: 12px 0;
  font-size: 1.1em;
  cursor: pointer;
  transition: background 0.14s;
  min-width: 0;
  min-height: 44px;
}

.calc-btn:active,
.calc-btn:hover {
  background: var(--calc-btn-hover, #1976d2);
  color: #fff;
}

#calcEquals {
  background: var(--calc-equals-bg, #1976d2) !important;
  color: #fff !important;
  font-weight: bold;
}
</style>



<!-- Calculator Logic (place after the calculator HTML, before </body>) -->
<script>
let calcBuffer = "";

function calcInput(char) {
  // Prevent multiple decimals in the same number
  if (char === '.' && calcBuffer.split(/[\+\-\*\/]/).pop().includes('.')) return;
  calcBuffer += char;
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcClear() {
  calcBuffer = "";
  document.getElementById('calcDisplay').value = "";
}
function calcBackspace() {
  calcBuffer = calcBuffer.slice(0, -1);
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcEquals() {
  try {
    if (/^[0-9+\-*/.() ]+$/.test(calcBuffer)) {
      let result = eval(calcBuffer);
      document.getElementById('calcDisplay').value = result;
      calcBuffer = String(result);
    } else {
      document.getElementById('calcDisplay').value = "Err";
      calcBuffer = "";
    }
  } catch {
    document.getElementById('calcDisplay').value = "Err";
    calcBuffer = "";
  }
}
</script>

  <div class="header-left">
    <h1 class="header-title">FIN Calculator</h1>
    <div class="version-info"> <span data-tooltip=
    "<strong>Recent Updates
    </strong>
    <ul>(v2.0.51)
    <li>Expanded chart is wider now for better visibility</li>
    </ul>
    <ul>(v2.0.50)
    <li>Restricted Stop Saving Age to the range between start saving age and retirement age</li>
    </ul>
    <ul>(v2.0.49)
    <li>Enhanced scenario buttons for parameters that show practical conversational points.</li>
    <li>Overhauled calculation engine for perfect accuracy (Target Plan now ends at $0).</li>
    <li>Redesigned 'Target Plan' to show an intuitive savings path from $0.</li>
    <li>Added independent start age for CPP benefits (60-70).</li>
    <li>Fixed 'Today's $' & 'Forever' mode calculations.</li>
    <li>Added conditional highlighting for successful plans.</li>
    <li>Redesigned end cotnribution age to a slider format with limited range from start to retirement age</li>
    </ul>
    ">v2.0.51</span> ‚Ä¢ Updated: August 12, 2025</div>
  </div>
</div>

<!-- Header Center Section -->
<div class="header-center">
  
<!-- Toggle Bar -->
  <div class="toggle-bar">

   <!-- Dark Mode Toggle -->
    <div class="toggle-item">
      <span>Dark Mode üåô</span>
      <label class="switch">
        <input type="checkbox" id="darkModeToggle">
        <span class="slider"></span>
      </label>
    </div>

    <!-- Display Toggle -->
    <div class="toggle-item">
  <span
    id="finDisplayLabelContainer"
    data-tooltip="Show results in <strong>today‚Äôs dollars</strong> or <strong>inflated future dollars</strong>. Due to inflation, the amount you will need in the future to buy the same things you buy today will be much higher."
  
  >
    <span id="finDisplayLabelPrefix">Display:</span>
    <strong id="finDisplayLabel">Future $</strong>
  </span>

  <label class="switch">
    <input type="checkbox" id="finDisplayToggle" checked>
    <span class="slider"></span>
  </label>
</div>


    <!-- Mode Toggle -->
<div class="toggle-item">
  <span
    id="modeLabelWrapper"
    data-tooltip="Choose Life Expectancy mode (investments are expected to last up to this age) or Forever drawdown style (the money lasts forever in the hands of your beneficiaries)."
  
  >
    <span id="modeLabelPrefix">Mode:</span>
    <strong id="modeLabel">Life Expectancy</strong>
  </span>

  <label class="switch">
    <input type="checkbox" id="drawdownToggle">
    <span class="slider"></span>
  </label>
</div>

</div> <!-- Closes: <div class="toggles-row"> -->
</div> <!-- Closes: <div class="toggles-container"> -->
</div> <!-- Closes: <div class="header-flex"> -->


<!-- Scenario Buttons Row -->
<div class="top-interactive-area">

  <div id="scenario-row" class="scenario-buttons">
    <button class="scenario-btn active" data-scenario="default">Default</button>
    <button class="scenario-btn" data-scenario="child-zero">Child Born</button>
    <button class="scenario-btn" data-scenario="start-19">Start Age 19</button>
    <button class="scenario-btn" data-scenario="start-25">Start Age 25</button>
    <button class="scenario-btn" data-scenario="start-30">Start Age 30</button>
    <button class="scenario-btn" data-scenario="start-40">Start Age 40</button>
    <button class="scenario-btn" data-scenario="start-50">Start Age 50</button>
    <button class="scenario-btn" data-scenario="start-60">Start Age 60</button>
  </div>

  <div class="summary-bar">
    <div class="output tooltip-container" data-tooltip="Lump sum needed at desired retirement age to cover all future income goals (also known as Financial Independence Number).">
      <div class="label-row"><span class="icon">üí∞</span> <span class="label-text">FIN</span></div>
      <strong id="finAmount">$0</strong>
    </div>
    <div class="output tooltip-container" data-tooltip="How much extra you'd need to save monthly to meet your financial independence target.">
      <div class="label-row"><span class="icon">üìÖ</span> <span class="label-text">Monthly FIN</span></div>
      <strong id="monthlyNeeded">$0</strong>
    </div>
    <div class="output tooltip-container" data-tooltip="How much you'd need invested TODAY to avoid having to put any extra MONTHLY contributions and still meet your retirement income goal.">
      <div class="label-row"><span class="icon">üéØ</span> <span class="label-text">Fully Funded</span></div>
      <strong id="fullyFundedNow">$0</strong>
    </div>
    <div class="output tooltip-container" data-tooltip="Income Protection Number: Estimated life insurance need based on your current income requirement.">
      <div class="label-row"><span class="icon">üõ°Ô∏è</span> <span class="label-text">IPN</span></div>
      <strong id="incomeProtectionNumber">$0</strong>
    </div>
  </div>

</div>


</div><!--end of header-flex with title, version and toggles-->


</div>

<div id="ageWarning">‚ö†Ô∏è Invalid ages auto-adjusted.</div>
<div class="main-wrapper"> <!-- full body wrapper-->


<div class="main-layout"> <!-- the entire main page layout-->

<div class="left-column">

<div class="inputs-container"> <!-- Input boxes, sliders -->

  <!-- Row 1 -->
  <div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
    <div style="flex: 0.5;">
      <label for="desiredIncome" data-tooltip="Monthly income you want during retirement, in today‚Äôs dollars." class="tooltip-label">Income Goal</label>
      <input type="number" id="desiredIncome" />
    </div>
    <div style="flex: 0.5;">
      <label for="futureIncomeDisplay" data-tooltip="Inflation-adjusted monthly income at retirement age to match today‚Äôs value.">Future Value</label>
      <input type="text" id="futureIncomeDisplay" readonly />
    </div>
  </div>



  <div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
    <div style="flex: 0.5;">
      <label for="currentInvestment" data-tooltip="How much money have you saved so far, in the bank, mutual funds, stocks, GICs, CASH?">Savings Now</label>
      <input type="number" id="currentInvestment" />
    </div>
    <div style="flex: 0.5;">
      <label for="futureValueInvestmentDisplay" data-tooltip="Future value of your existing investments by retirement.">Future Value</label>
      <input type="text" id="futureValueInvestmentDisplay" class="readonly-box autoscale" readonly />
    </div>
  </div>
<div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
  <div style="flex: 0.5;">
    <label for="cppBenefit" data-tooltip="Enter your estimated monthly CPP (Canada Pension Plan) benefit in today‚Äôs dollars.">Monthly CPP</label>
    <input type="number" id="cppBenefit" value="0" />
  </div>
  <div style="flex: 0.5;">
    <label for="cppStartAge" data-tooltip="The age you plan to start receiving CPP benefits. Must be between 60 and 70.">at Age</label>
    <input type="number" id="cppStartAge" value="65" min="60" max="70" step="1" />
  </div>
</div>
  
  <!-- Row 2 -->
  <div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
    <div style="flex: 0.5;">
      <label for="monthlyContribution" data-tooltip="How much money are you putting away right now monthly?">Add Monthly</label>
      <input type="number" id="monthlyContribution" />
    </div>
    <div style="flex: 0.5;">
      <label for="futureValueContributionDisplay" data-tooltip="Total value of your contributions by retirement, including compounding growth.">Grows to $</label>
      <input type="text" id="futureValueContributionDisplay" class="readonly-box autoscale" readonly />
    </div>
  </div>

<div class="input-group" style="display: flex; align-items: flex-end; gap: 12px;">
  <div style="flex: 0.5;">
    <label for="inheritanceAmount" data-tooltip="Lump sum amount you expect to receive (e.g., inheritance, sale of a house, etc) at a specific age. By entering a negative amount, you can also calculate the impact of a one time withdrawal at a specific age.">Windfall $</label>
    <input type="number" id="inheritanceAmount" min="0" value="0" />
  </div>
  <div style="flex: 0.5;">
    <label for="inheritanceAge" data-tooltip="Age at which you expect to receive the inheritance (must be between start age and retirement age).">at Age</label>
    <input type="number" id="inheritanceAge" min="0" value="0" step="1" />
  </div>
</div>

  <div class="slider-group">
    <label for="stopAge" data-tooltip="The age at which you plan to STOP monthly investing contributions. This age is dynamically updated to be between your Start Age and Retirement Age.">Stop Saving Age</label>
    <div class="slider-container">
      <input type="range" id="stopAge" min="0" max="100" step="1">
      <input type="text" id="stopAgeText">
    </div>
  </div>

  <!-- Row 3 -->
  <div class="slider-group">
    <label for="startAge" data-tooltip="Your current age or the age at which savings start.">Start Saving Age</label>
    <div class="slider-container">
      <input type="range" id="startAge" min="0" max="100" step="1">
      <input type="text" id="startAgeText">
    </div>
  </div>

  <div class="slider-group">
    <label for="preReturn" data-tooltip="Expected average annual rate of return on your investments before retirement, during accumulation phase.">Growth Rate %</label>
    <div class="slider-container">
      <input type="range" id="preReturn" min="0" max="9" step="1">
      <input type="text" id="preReturnText">
    </div>
  </div>

  <!-- Row 4 -->
  <div class="slider-group">
    <label for="retireAge" data-tooltip="The age when you stop working and begin withdrawals. For lifelong income, switch the mode to &quot;Forever&quot;.">Retirement Age</label>
    <div class="slider-container">
      <input type="range" id="retireAge" min="20" max="95" step="1">
      <input type="text" id="retireAgeText">
    </div>
  </div>

  <div class="slider-group">
    <label for="postReturn" data-tooltip="Expected average annual return on your investments during retirement or from the age you set for financial independence.">Retire Rate %</label>
    <div class="slider-container">
      <input type="range" id="postReturn" min="0" max="9" step="1">
      <input type="text" id="postReturnText">
    </div>
  </div>

  <!-- Row 5 -->
  <div class="slider-group">
    <label for="endAge" id="lifeLabel" data-tooltip="What's your life expectancy? Default is 100. In FIRE mode, your money is set to last forever.">Life Expectancy Age</label>
    <div class="slider-container">
      <input type="range" id="endAge" min="55" max="120" step="1">
      <input type="text" id="endAgeText">
    </div>
  </div>

  <div class="slider-group">
    <label for="inflationRate" data-tooltip="Average expected annual increase in cost of living.">Inflation Rate %</label>

    <div class="slider-container">
      <input type="range" id="inflationRate" min="0" max="7" step="1">
      <input type="text" id="inflationRateText">
    </div>
  </div>

</div> <!-- end of the input container -->

<!--
 <div class="results-container"> 

  </div> <!--end of results-container-->

</div> <!--end of left-column-->

<div class="middle-column">

  <div class="graph-container"> <!--graph container starting-->

    <div id="finChartContainer">
  <canvas id="finChart"></canvas>

</div>

    
    <div style="display: flex; justify-content: center; gap: 15px;">
  <div class="graph-expand-btn-2" onclick="toggleGraphSize()">‚ÜîÔ∏è Expand the Chart</div>
</div>
<p class="chart-disclaimer">
    This illustrative calculator is designed to be an informational and educational tool only. This illustration is a hypothetical and does not represent an actual investment. This illustration uses a constant rate, compounded on a monthly basis, unlike actual investments which will fluctuate in value and could be significantly impacted by periods of negative returns. It does not include fees, taxes, expenses, or extra withdrawals before retirement, which if included, would lower results. Monthly withdrawal is at the beginning of the month, inflation applied annually. There is no guarantee you will achieve these results. The historical inflation rate is 3%.
  </p>

  </div> <!-- end of the graph-container-->


<style>
  /* FAQ container styles */
  #faq {
  margin-top: 20px;
  background: var(--card-bg, #fff);
  color: var(--text-color, #000);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 0.9rem;
  padding: 0;
  width: 100%;
  max-width: 700px;         /* Match .middle-column width */
  margin-left: auto;
  margin-right: auto;
  box-sizing: border-box;
}
/* FAQ main header */
  #faqHeader {
  cursor: pointer;
  padding: 8px 12px;                /* smaller padding */
  font-weight: 600;
  font-size: 1rem;                  /* smaller font */
  user-select: none;
  background: #e0e7ff;              /* soft blue background */
  color: #1a237e;                   /* navy text */
  border-radius: 6px;
  border: 1px solid #c5cae9;        /* subtle border */
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s ease;
}

#faqHeader:hover {
  background: #d0d8ff;
}
  /* FAQ main content container, hidden by default */
  #faqContent {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease;
    background: var(--card-bg, #f9f9f9);
    border-radius: 0 0 8px 8px;
    padding: 0 20px;
  }

  #faqContent.open {
    padding: 16px 20px;
    max-height: 1000px; /* enough for content */
  }

  /* Individual question styles */
  .faq-item {
    border-bottom: 1px solid #ddd;
    padding: 12px 0;
  }

  .faq-question {
    cursor: pointer;
    font-weight: 600;
    position: relative;
    padding-right: 24px;
    user-select: none;
  }

  .faq-question::after {
    content: '+';
    position: absolute;
    right: 0;
    top: 0;
    font-weight: 700;
    font-size: 1.2rem;
    line-height: 1;
    transition: transform 0.3s ease;
  }

  .faq-question.open::after {
    content: '-';
    transform: rotate(180deg);
  }

  .faq-answer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
    padding-left: 8px;
    color: #333;
    font-weight: normal;
    font-size: 0.9rem;
  }

  .faq-answer.open {
    padding-top: 8px;
    padding-bottom: 8px;
    max-height: 500px; /* large enough for most answers */
  }

  /* Dark mode tweaks */
  body.dark #faq {
    background: #1a1a1a;
    color: #eee;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }

  body.dark #faqHeader {
  background: #1e1e1e;
  color: #ddd;
  border: 1px solid #333;
}
body.dark #faqHeader:hover {
  background: #2a2a2a;
}
  body.dark #faqContent {
    background: #222;
  }

  body.dark .faq-item {
    border-color: #444;
  }

  body.dark .faq-answer {
    color: #ccc;
  }
  
  .summary-bar {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 32px;
  margin: 10px auto 10px;
  font-size: 0.95rem;
  max-width: 960px;
}

.summary-item {
  text-align: center;
  position: relative;
  min-width: 130px;
}

.summary-item strong {
  font-size: 1.4rem;
  color: #007bff;
  display: block;
  margin-bottom: 4px;
}

.summary-item .label-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-weight: 600;
  font-size: 1rem;
}

.summary-item .icon {
  font-size: 1.3rem;
  line-height: 1;
}

body.dark .summary-item strong {
  color: #3399ff;
}

/* Removes top padding from only the first item in the inputs column */
.inputs-container > .input-group:first-child,
.inputs-container > .slider-group:first-child {
  padding-top: 0;
}

.summary-bar .output {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}
@media (max-width: 540px) {
  .summary-bar {
    justify-content: center;
    gap: 24px;
    margin-top: 12px;
  }
}

body.dark .summary-bar {
  background-color: transparent;
}
.scenario-btn.active:hover {
  background-color: #007bff !important;
  color: white !important;
  border-color: #007bff !important;
}

#finChartContainer {
  width: 100%;
  max-width: none;
  height: 100%;
  border-radius: 8px;
  display: block;
  overflow: hidden;
}


/* Light Mode Styling */
body:not(.dark) #finChartContainer {
  background-color: #f9f9fc;
  border: 1px solid #bbb;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

/* Optional Dark Mode */
body.dark #finChartContainer {
  background-color: #1e1e1e;
  border: 1px solid #444;
}

#finChart {
  display: block;
  width: 100%;
  height: auto;
  background-color: transparent;
}
.chart-disclaimer {
  font-size: 0.70rem; 
  color: #555;
  text-align: center;
  margin-top: 15px;
  line-height: 1.4;
  max-width: auto; /* Prevents it from becoming too wide */
  margin-left: auto;
  margin-right: auto;
}

body.dark .chart-disclaimer {
  color: #aaa;
}

/* --- Style for the new "Expand in Place" button --- */
.graph-expand-btn-2 {
  /* Positioning and Shape */
  display: block;
  text-align: center;
  width: fit-content;
  margin: 12px 0 0; /* Aligns with the other button */
  padding: 6px 16px;
  border-radius: 99px; /* Pill shape */
  
  /* Font and Appearance */
  font-size: 0.8rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

/* Light Mode Colors */
body:not(.dark) .graph-expand-btn-2 {
  background-color: #e8f0fe;
  color: #1967d2;
}

/* Dark Mode Colors */
body.dark .graph-expand-btn-2 {
  background-color: #2e3a47;
  color: #8ab4f8;
}

/* Hover Effect */
.graph-expand-btn-2:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

body.dark .graph-expand-btn-2:hover {
   box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}



</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle FAQ main section
  const faqHeader = document.getElementById('faqHeader');
  const faqContent = document.getElementById('faqContent');
  const faqToggleIcon = document.getElementById('faqToggleIcon');

  faqHeader.addEventListener('click', () => {
    const expanded = faqHeader.getAttribute('aria-expanded') === 'true';
    faqHeader.setAttribute('aria-expanded', String(!expanded));
    faqContent.classList.toggle('open');
    faqContent.setAttribute('aria-hidden', String(expanded));
    faqToggleIcon.textContent = expanded ? '‚ñº' : '‚ñ≤';
  });
  faqHeader.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      faqHeader.click();
    }
  });

  // Toggle individual FAQ questions
  document.querySelectorAll('.faq-question').forEach(question => {
    question.addEventListener('click', () => {
      const expanded = question.getAttribute('aria-expanded') === 'true';
      question.setAttribute('aria-expanded', String(!expanded));

      const answer = document.getElementById(question.getAttribute('aria-controls'));
      if (answer) {
        if (expanded) {
          answer.hidden = true;
          answer.classList.remove('open');
        } else {
          answer.hidden = false;
          answer.classList.add('open');
        }
      }
      question.classList.toggle('open');
    });

    question.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        question.click();

      }
    });
  });
  });
</script>

</div>



<div class="right-column"> <!--start of right-column-->

<!-- table view of the accumulation and decumulation -->
<div id="tableView" style="width:100%; max-width:900px; overflow-x:auto; margin-bottom:30px;"></div>
<section id="faq" aria-label="Frequently Asked Questions">
  <div id="faqHeader" tabindex="0" role="button" aria-expanded="false" aria-controls="faqContent">
    Frequently Asked Questions
    <span aria-hidden="true" id="faqToggleIcon">‚ñº</span>
  </div>
  <div id="faqContent" role="region" aria-hidden="true">

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer1" id="question1">
        What is the FIN (Financial Independence Number)?
      </div>
      <div class="faq-answer" id="answer1" aria-labelledby="question1" hidden>
        The FIN represents the lump sum amount you need at retirement to generate your desired income for life.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer2" id="question2">
        Why does the FIN change for different start age?
      </div>
      <div class="faq-answer" id="answer2" aria-labelledby="question2" hidden>
        The FIN changes with start age because the amount you need at retirement depends on how many years you have to save and how inflation impacts the value of your desired income. Starting earlier means your desired income needs to be inflated over a longer period before retirement, which changes the lump sum required.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer3" id="question3">
        How is the ‚ÄúFuture $‚Äù display different from ‚ÄúToday's $‚Äù?
      </div>
      <div class="faq-answer" id="answer3" aria-labelledby="question3" hidden>
        ‚ÄúFuture $‚Äù adjusts your income and savings goals to account for inflation, showing the amount of money you will need in inflated future dollars. ‚ÄúToday's $‚Äù shows the equivalent value in today‚Äôs dollars, removing the effects of inflation to provide a clearer comparison.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer4" id="question4">
        What does ‚ÄúFully Funded‚Äù mean?
      </div>
      <div class="faq-answer" id="answer4" aria-labelledby="question4" hidden>
        ‚ÄúFully Funded‚Äù shows how much you‚Äôd need invested today to meet your retirement goals without adding extra monthly contributions.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer5" id="question5">
        What is the difference between Life Expectancy and Forever (FIRE style) modes?
      </div>
      <div class="faq-answer" id="answer5" aria-labelledby="question5" hidden>
        Life Expectancy mode plans your finances to last until a set age, while Forever (FIRE) mode plans for perpetual income with no set end date.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" tabindex="0" role="button" aria-expanded="false" aria-controls="answer6" id="question6">
        How do changes in inflation or investment return rates affect my results?
      </div>
      <div class="faq-answer" id="answer6" aria-labelledby="question6" hidden>
        Inflation and return rates impact how much you need to save and your investment growth, which affects your FIN and funding requirements.
      </div>
    </div>

  </div>
</section>          
</div> <!--end of right-container-->
    

</div> <!-- end of the main-wrapper, full page-->

</div> <!-- end of #content -->

<!-- PASSWORD CHECK SCRIPT (must be the first script on the list)-->
  <script>
   document.addEventListener('DOMContentLoaded', () => {
  const correctPassword = 'fna4success';
  const overlay = document.getElementById('passwordOverlay');
  const content = document.getElementById('content');
  const input = document.getElementById('passwordInput');
  const btn = document.getElementById('passwordBtn');
  const errorMsg = document.getElementById('passwordError');

  // Check sessionStorage on load
  if (sessionStorage.getItem('accessGranted') === 'true') {
    overlay.style.display = 'none';
    content.style.display = 'block';
    return;
  }

  btn.addEventListener('click', checkPassword);
  input.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') checkPassword();
  });

  function checkPassword() {
    if (input.value === correctPassword) {
      sessionStorage.setItem('accessGranted', 'true');

      overlay.style.display = 'none';
      content.style.display = 'block';
      errorMsg.style.display = 'none';
    } else {
      errorMsg.style.display = 'block';
      input.value = '';
      input.focus();
    }
  }
});

  </script>
  
  
<!-- script to set the default for scenarios-->
<script>
 // Define the "all-zero" state specifically for the Default button
 const zeroScenario = {
    desiredIncome: 0,
    currentInvestment: 0,
    monthlyContribution: 0,
    cppBenefit: 0,
    cppStartAge: 65,
    stopAge: 65,
    inheritanceAmount: 0,
    inheritanceAge: 0,
    inflationRate: 2,
    preReturn: 9,
    postReturn: 7,
    startAge: 20,
    retireAge: 65,
    endAge: 85
 };

 // Define a base for the *active* scenarios (note: monthlyContribution is removed from here)
 const baseActiveScenario = {
    ...zeroScenario, 
    desiredIncome: 5000, 
 };

 // Rebuild the scenarios object with specific, calculated monthly contributions for each age
 const scenarios = {
    "default": zeroScenario,
    "child-zero": { ...baseActiveScenario, startAge: 0,  monthlyContribution: 0},
    "start-19":   { ...baseActiveScenario, startAge: 19, monthlyContribution: 0 },
    "start-25":   { ...baseActiveScenario, startAge: 25, monthlyContribution: 0 },
    "start-30":   { ...baseActiveScenario, startAge: 30, monthlyContribution: 0 },
    "start-40":   { ...baseActiveScenario, startAge: 40, monthlyContribution: 0 },
    "start-50":   { ...baseActiveScenario, startAge: 50, monthlyContribution: 0 },
    "start-60":   { ...baseActiveScenario, startAge: 60, monthlyContribution: 0 }
 };

¬† function setValue(id, value) {
¬† ¬† const el = document.getElementById(id);
¬† ¬† if (el) {
¬† ¬† ¬† el.value = value;
¬† ¬† ¬† el.dispatchEvent(new Event('input', { bubbles: true }));
¬† ¬† }
¬† }

¬† document.querySelectorAll(".scenario-btn").forEach(btn => {
¬† ¬† btn.addEventListener("click", () => {
¬† ¬† ¬† // UI highlight
¬† ¬† ¬† document.querySelectorAll(".scenario-btn").forEach(b => b.classList.remove("active"));
¬† ¬† ¬† btn.classList.add("active");
localStorage.setItem('lastScenario', btn.dataset.scenario);

¬† ¬† ¬† const s = scenarios[btn.dataset.scenario];
¬† ¬† ¬† if (!s) return;

¬† ¬† ¬† // Set plain inputs
¬† ¬† ¬† setValue("desiredIncome", s.desiredIncome);
¬† ¬† ¬† setValue("currentInvestment", s.currentInvestment);
¬† ¬† ¬† setValue("monthlyContribution", s.monthlyContribution);
¬† ¬† ¬† setValue("cppBenefit", s.cppBenefit);¬†
¬† ¬† ¬† setValue("cppStartAge", s.cppStartAge);¬†
¬† ¬† ¬† setValue("stopAge", s.stopAge);
¬† ¬† ¬† setValue("inheritanceAmount", s.inheritanceAmount);
¬† ¬† ¬† setValue("inheritanceAge", s.inheritanceAge);

¬† ¬† ¬† // Set sliders + matching number inputs
¬† ¬† ¬† setValue("inflationRate", s.inflationRate);
¬† ¬† ¬† setValue("preReturn", s.preReturn);
¬† ¬† ¬† setValue("postReturn", s.postReturn);
¬† ¬† ¬† setValue("startAge", s.startAge);
¬† ¬† ¬† setValue("retireAge", s.retireAge);
¬† ¬† ¬† setValue("endAge", s.endAge);
¬† ¬† });
¬† });
</script>


<script>
  let finChart;
  let isCurrentPlanSuccessful = false;
</script>

<script>
// Final, direct function for in-place graph expansion
let isChartExpanded = false;

function toggleGraphSize() {
  const mainLayout     = document.querySelector('.main-layout');
  const expandButton   = document.querySelector('.graph-expand-btn-2');
  const chartContainer = document.getElementById('finChartContainer');
  const canvas         = document.getElementById('finChart');
  const inputsContainer = document.querySelector('.inputs-container');

  if (!finChart || !mainLayout || !chartContainer || !inputsContainer) return;

  mainLayout.classList.toggle('chart-is-expanded');
  isChartExpanded = mainLayout.classList.contains('chart-is-expanded');

  // Let CSS control size; do NOT lock a pixel height
  chartContainer.style.removeProperty('height');
  canvas.style.removeProperty('height');
  canvas.style.removeProperty('width');

  if (isChartExpanded) {
    // Expanded: fill width, flexible height (no stretching)
    finChart.options.responsive = true;
    finChart.options.maintainAspectRatio = false;
    expandButton.innerHTML = '‚ÜîÔ∏è Shrink View';
  } else {
    // Normal: restore usual responsive/aspect behavior
    finChart.options.responsive = true;
    finChart.options.maintainAspectRatio = true;
    expandButton.innerHTML = '‚ÜîÔ∏è Expand the Chart';
  }

  finChart.update('none');
  finChart.resize();
}


</script>


<!--script to load/save settings locally-->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      
     const els = {};
['currentInvestment','desiredIncome','monthlyContribution','cppBenefit','cppStartAge',
 'stopAge','stopAgeText','inheritanceAmount','inheritanceAge', 
 'inflationRate','inflationRateText','preReturn','preReturnText',
 'postReturn','postReturnText','startAge','startAgeText',
 'retireAge','retireAgeText','endAge','endAgeText',
 'monthlyNeeded','finAmount','ageWarning'].forEach(id=>{
  els[id]=document.getElementById(id);
  });

const ctx = document.getElementById('finChart').getContext('2d');

finChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Target Plan (Required)',
        data: [],
        borderColor: '#1a73e8',
        backgroundColor: 'rgba(26,115,232,0.1)',
        fill: true,
        pointRadius: 3,
        pointHoverRadius: 6,
        tension: 0.25
      },
      {
        label: 'Your Current Plan',
        data: [],
        borderColor: '#fb8c00',
        backgroundColor: 'rgba(251,140,0,0.1)',
        fill: true,
        pointRadius: 3,
        pointHoverRadius: 6,
        tension: 0.25
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    scales: {
      x: {
        type: 'linear', // üõ†Ô∏è THIS is the magic that makes annotations match!
        title: {
          display: true,
          text: 'Age (Years)'
        },
        ticks: {
          stepSize: 1, // show every year
          callback: value => value.toString()
        }
      },
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Portfolio Value ($)'
        },
        ticks: {
          callback: v => '$' + v.toLocaleString()
        }
      }
    },
    plugins: {
      legend: {
        labels: {
          usePointStyle: true,
          pointStyle: 'line'
        }
      },
      tooltip: {
        callbacks: {
          label: ctx => '$' + ctx.parsed.y.toLocaleString()
        }
      },
      title: {
        display: true,
        text: 'Portfolio Growth & Drawdown'
      },
      annotation: {
        drawTime: 'afterDraw',
        annotations: {} // will be filled dynamically in calculateFIN()
      }
    }
  }
});


        document.getElementById("drawdownToggle").addEventListener("change", function () {
        const isFire = this.checked;
        document.getElementById("modeLabel").textContent = isFire ? "Forever)" : "Life Expectancy";

        // Also change the slider label for Life Expectancy
        const lifeLabel = document.querySelector('label[for="endAge"]');
        if (lifeLabel) {

          lifeLabel.textContent = isFire ? "Mode: Perpetual" : "Life Expectancy";
        }

        calculateFIN();
      });

        document.getElementById("finDisplayToggle").addEventListener("change", function () {
        const label = this.checked ? "Future $" : "Today's $";
        document.getElementById("finDisplayLabel").textContent = label;
        
        calculateFIN();
      });

function loadSettings(){
  const saved = localStorage.getItem('finToolSettings');
  if (saved) {
    const s = JSON.parse(saved);
    Object.keys(s).forEach(k => {
      if (els[k]) els[k].value = s[k];
    });

    // Set min/max for inheritanceAge based on loaded startAge and retireAge
    els.inheritanceAge.min = els.startAge.value;
    els.inheritanceAge.max = els.retireAge.value;

    // üéØ Match scenario by values
    const mapped = {
      desiredIncome: +s.desiredIncome,
      currentInvestment: +s.currentInvestment,
      monthlyContribution: +s.monthlyContribution,
      stopAge: +s.stopAge,
      inheritanceAmount: +s.inheritanceAmount, // Add inheritance fields
      inheritanceAge: +s.inheritanceAge,
      inflationRate: +s.inflationRate,
      preReturn: +s.preReturn,
      postReturn: +s.postReturn,
      startAge: +s.startAge,
      retireAge: +s.retireAge,
      endAge: +s.endAge
    };

    let matchedScenario = 'custom';
    for (const [name, scenario] of Object.entries(scenarios)) {
      const isMatch = Object.entries(scenario).every(([key, val]) =>
        mapped.hasOwnProperty(key) && +mapped[key] === +val
      );
      if (isMatch) {
        matchedScenario = name;
        break;
      }
    }

    // ‚úÖ Prefer last clicked scenario if stored
    const last = localStorage.getItem('lastScenario');
    const activeScenario = (last && scenarios[last]) ? last : matchedScenario;

    // üñ±Ô∏è Apply active scenario UI
    document.querySelectorAll(".scenario-btn").forEach(b => {
      b.classList.toggle("active", b.dataset.scenario === activeScenario);
    });
  } else {
    resetDefaults();
  }


  //calculateFIN();
}


// Function to update all chart colors based on the current theme
function updateChartColors() {
¬† ¬† // Make sure the chart exists before trying to update it
¬† ¬† if (!window.finChart) {
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† const isDark = document.body.classList.contains('dark');

¬† ¬† // Define color palettes for light and dark modes
¬† ¬† const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
¬† ¬† const textColor = isDark ? '#ddd' : '#666';
¬† ¬† const titleColor = isDark ? '#eee' : '#222';
¬† ¬† const annotationLabelBg = isDark ? '#444' : 'rgba(0,0,0,0.7)';
¬† ¬† const annotationLabelColor = '#fff';

¬† ¬† const options = finChart.options;

¬† ¬† // 1. Update Target Plan (Dataset 0) Colors
¬† ¬† finChart.data.datasets[0].borderColor = isDark ? '#42a5f5' : '#1a73e8';
¬† ¬† finChart.data.datasets[0].backgroundColor = isDark ? 'rgba(66, 165, 245, 0.2)' : 'rgba(26, 115, 232, 0.1)';

    // --- MODIFIED: Update Current Plan (Dataset 1) Colors ---
    if (isCurrentPlanSuccessful) {
        // Use GREEN color scheme if the plan is successful
        finChart.data.datasets[1].borderColor = isDark ? '#81c784' : '#2e7d32';
        finChart.data.datasets[1].backgroundColor = isDark ? 'rgba(129, 199, 132, 0.2)' : 'rgba(46, 125, 50, 0.1)';
    } else {
        // Use the default ORANGE color scheme
        finChart.data.datasets[1].borderColor = isDark ? '#ffca28' : '#fb8c00';
        finChart.data.datasets[1].backgroundColor = isDark ? 'rgba(255, 202, 40, 0.2)' : 'rgba(251, 140, 0, 0.1)';
    }

¬† ¬† // 2. Update Scale (Axes, Ticks, Grid) Colors
¬† ¬† if (options.scales) {
        // Set the axis min/max and stepSize for better readability
        const sa = +document.getElementById('startAge').value;
        const ea = +document.getElementById('endAge').value;
        options.scales.x.min = sa;
        options.scales.x.max = ea;
        options.scales.x.ticks.stepSize = 5;
        
¬† ¬† ¬† ¬† options.scales.x.grid.color = gridColor;
¬† ¬† ¬† ¬† options.scales.y.grid.color = gridColor;
¬† ¬† ¬† ¬† options.scales.x.ticks.color = textColor;
¬† ¬† ¬† ¬† options.scales.y.ticks.color = textColor;
¬† ¬† ¬† ¬† options.scales.x.title.color = textColor;
¬† ¬† ¬† ¬† options.scales.y.title.color = textColor;
¬† ¬† }

¬† ¬† // 3. Update Plugin (Legend, Title, Annotations) Colors
¬† ¬† if (options.plugins) {
¬† ¬† ¬† ¬† if (options.plugins.legend) {
¬† ¬† ¬† ¬† ¬† ¬† options.plugins.legend.labels.color = textColor;
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† if (options.plugins.title) {
¬† ¬† ¬† ¬† ¬† ¬† options.plugins.title.color = titleColor;
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† if (options.plugins.annotation && options.plugins.annotation.annotations) {
¬† ¬† ¬† ¬† ¬† ¬† ¬†Object.values(options.plugins.annotation.annotations).forEach(ann => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(ann.label) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ann.label.backgroundColor = annotationLabelBg;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ann.label.color = annotationLabelColor;
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬†});
¬† ¬† ¬† ¬† }
¬† ¬† }
¬† ¬†¬†
¬† ¬† // 4. Trigger a chart update to apply the new colors
¬† ¬† finChart.update();
}

// DARK MODE PERSISTENCE
const darkToggle = document.getElementById('darkModeToggle');

darkToggle.addEventListener('change', () => {
  document.body.classList.toggle('dark', darkToggle.checked);
  localStorage.setItem('darkMode', darkToggle.checked ? 'enabled' : 'disabled');
  
  // Call the centralized function to update all chart colors
  updateChartColors(); 
});

// Set the initial state of the toggle and theme when the page loads
if (localStorage.getItem('darkMode') === 'enabled') {
  document.body.classList.add('dark');
  darkToggle.checked = true;
}

     function saveSettings(){
  const data={};
  Object.keys(els).forEach(k=>{
    if(['monthlyNeeded','finAmount','ageWarning'].includes(k)) return;
    data[k]=els[k].value;
  });
  localStorage.setItem('finToolSettings',JSON.stringify(data));
}




      
function validateAges(){
  let sa = +els.startAge.value, ra = +els.retireAge.value, ea = +els.endAge.value, ia = +els.inheritanceAge.value, csa = +els.cppStartAge.value, warn = false;
  let warnText = '‚ö†Ô∏è Invalid ages auto-adjusted.';

  if (ra <= sa) { 
    ra = sa + 1; 
    els.retireAge.value = ra; 
    els.retireAgeText.value = ra; 
    warn = true; 
  }
  if (ea <= ra) { 
    ea = ra + 1; 
    els.endAge.value = ea; 
    els.endAgeText.value = ea; 
    warn = true; 
  }
  if (ia !== 0 && (ia < sa || ia > ra)) { 
    ia = sa; 
    els.inheritanceAge.value = ia; 
    warn = true; 
    warnText = `‚ö†Ô∏è Inheritance age must be between ${sa} and ${ra}. Adjusted to ${ia}.`;
  }
  // New CPP Age Validation
  if (csa < 60 || csa > 70) {
    csa = Math.max(60, Math.min(csa, 70)); // Clamp between 60 and 70
    els.cppStartAge.value = csa;
    warn = true;
    warnText = `‚ö†Ô∏è CPP start age must be between 60 and 70. Adjusted to ${csa}.`;
  }

  els.ageWarning.textContent = warnText;
  els.ageWarning.style.display = warn ? 'block' : 'none';
  
  els.inheritanceAge.min = sa;
  els.inheritanceAge.max = ra;

// Set the min and max for the Stop Saving Age slider
  els.stopAge.min = sa;
  els.stopAge.max = ra;
  
  // If the current stop age is now invalid, fix it
  if (+els.stopAge.value < sa) {
      els.stopAge.value = sa;
      els.stopAgeText.value = sa;
  }
  if (+els.stopAge.value > ra) {
      els.stopAge.value = ra;
      els.stopAgeText.value = ra;
  }
}

// HELPER 1: Simulates the accumulation of savings until retirement.
function simulateAccumulation(ci, mc, stopAge, sa, ra, mRate, inheritanceAmount, inheritanceAge) {
    let balance = ci;
    for (let age = sa; age < ra; age++) {
        // Add windfall at the beginning of the year it's received
        if (inheritanceAge > 0 && age === inheritanceAge) {
            balance += inheritanceAmount;
        }
        for (let month = 1; month <= 12; month++) {
            // Contribution at the beginning of the month
            let contribution = (age < stopAge) ? mc : 0;
            balance = (balance + contribution) * (1 + mRate);
        }
    }
    return balance;
}

// HELPER 2: Simulates the drawdown of a portfolio during retirement. This is our "ground truth".
function simulateDrawdown(startingBalance, di, cppBenefit, cppStartAge, sa, ra, ea, inf, post) {
    let balance = startingBalance;
    const drawdownData = [{ age: ra, balance: balance }];
    for (let year = ra; year < ea; year++) {
        let annualWithdrawal = di * 12 * Math.pow(1 + inf, year - sa);
        if (cppBenefit > 0 && year >= cppStartAge) {
            annualWithdrawal -= (cppBenefit * 12 * Math.pow(1 + inf, year - sa));
        }
        annualWithdrawal = Math.max(0, annualWithdrawal);
        const monthlyWithdrawal = annualWithdrawal / 12;

        for (let month = 1; month <= 12; month++) {
            // Withdrawal at the beginning of the month
            balance = (balance - monthlyWithdrawal) * (1 + post / 12);
        }
        drawdownData.push({ age: year + 1, balance: Math.max(0, balance) });
    }
    return drawdownData;
}

// HELPER 3: Calculates the exact FIN by running the drawdown simulation in reverse.
function calculateRealFIN(di, cppBenefit, cppStartAge, sa, ra, ea, inf, post) {
    let requiredBalance = 0.0;
    for (let year = ea - 1; year >= ra; year--) {
        let annualWithdrawal = di * 12 * Math.pow(1 + inf, year - sa);
        if (cppBenefit > 0 && year >= cppStartAge) {
            annualWithdrawal -= (cppBenefit * 12 * Math.pow(1 + inf, year - sa));
        }
        annualWithdrawal = Math.max(0, annualWithdrawal);
        const monthlyWithdrawal = annualWithdrawal / 12;

        let startOfYearBalance = requiredBalance;
        for (let month = 12; month >= 1; month--) {
            // Reverse logic for BEGINNING-of-month withdrawal
            startOfYearBalance = (startOfYearBalance / (1 + post / 12)) + monthlyWithdrawal;
        }
        requiredBalance = startOfYearBalance;
    }
    return requiredBalance;
}

function calculateFIN() {
    // This function is now self-contained and uses the correct helper functions.
    validateAges();

    // --- 1. GATHER ALL INPUTS ---
    const ci = +els.currentInvestment.value || 0;
    const di = +els.desiredIncome.value || 0;
    const mc = +els.monthlyContribution.value || 0;
    const inheritanceAmount = +els.inheritanceAmount.value || 0;
    const inheritanceAge = +els.inheritanceAge.value || 0;
    const cppBenefit = +els.cppBenefit.value || 0;
    const cppStartAge = +els.cppStartAge.value || 65;
    const inf = +els.inflationRate.value / 100 || 0;
    const pre = +els.preReturn.value / 100 || 0;
    const post = +els.postReturn.value / 100 || 0;
    const sa = +els.startAge.value,
          ra = +els.retireAge.value;
    let ea = +els.endAge.value;
    const stopAge = +els.stopAge.value || ra;
    const yrsTo = ra - sa;
    const mRate = pre / 12;
    const months = yrsTo * 12;
    const showFuture = document.getElementById("finDisplayToggle").checked;
    const drawdownType = document.getElementById("drawdownToggle").checked ? "perpetual" : "finite";

    if (drawdownType === 'perpetual') {
        ea = 120; // Use a long fixed end age for perpetual mode
    }

    // --- 2. PERFORM CORE CALCULATIONS (using helpers) ---
    const fin = calculateRealFIN(di, cppBenefit, cppStartAge, sa, ra, ea, inf, post);
    const fvOfCurrentPlan = simulateAccumulation(ci, mc, stopAge, sa, ra, mRate, inheritanceAmount, inheritanceAge);
    const fullyFundedNow = fin > 0 ? fin / Math.pow(1 + mRate, months) : 0;
    const totalMonthlySavingRequired = fin > 0 ? (mRate > 0 ? fin * mRate / (Math.pow(1 + mRate, months) - 1) : fin / months) : 0;

    // --- 3. UPDATE UI WIDGETS ---
    if (showFuture) {
        els.finAmount.textContent = '$' + fin.toLocaleString(undefined, { maximumFractionDigits: 0 });
    } else {
        const finTodaysDollars = fin / Math.pow(1 + inf, yrsTo);
        els.finAmount.textContent = '$' + finTodaysDollars.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    document.getElementById("fullyFundedNow").textContent = '$' + Math.max(0, fullyFundedNow - ci).toLocaleString(undefined, { maximumFractionDigits: 0 });
    const rem = Math.max(fin - fvOfCurrentPlan, 0);
    const monthlyNeed = rem > 0 ? (mRate > 0 ? rem * mRate / (Math.pow(1 + mRate, months) - 1) : rem / months) : 0;
    els.monthlyNeeded.textContent = '$' + monthlyNeed.toLocaleString(undefined, { maximumFractionDigits: 0 });
    const futureMonthlyIncome = di * Math.pow(1 + inf, yrsTo);
    document.getElementById('futureIncomeDisplay').value = futureMonthlyIncome.toLocaleString(undefined, { maximumFractionDigits: 0 });
    const fvCurr = ci * Math.pow(1 + mRate, months);
    const fvCont = mRate > 0 ? mc * ((Math.pow(1 + mRate, months) - 1) / mRate) * (1 + mRate) : mc * months;
    document.getElementById("futureValueInvestmentDisplay").value = fvCurr.toLocaleString(undefined, { maximumFractionDigits: 0 });
    document.getElementById("futureValueContributionDisplay").value = fvCont.toLocaleString(undefined, { maximumFractionDigits: 0 });
    document.getElementById("incomeProtectionNumber").textContent = `$${(di * 12 * 12).toLocaleString(undefined, {maximumFractionDigits:0})}`;
    autoscaleInputs();

    // --- 4. PREPARE CHART & TABLE DATA ---
    const targetMap = new Map();
    const currentMap = new Map();

    // Target Plan Accumulation (Starts at 0, uses total required savings)
    let balTarget = 0;
    for (let age = sa; age < ra; age++) {
        targetMap.set(age, balTarget);
        for (let month = 1; month <= 12; month++) {
            balTarget = (balTarget + totalMonthlySavingRequired) * (1 + mRate);
        }
    }
    
    // Current Plan Accumulation
    let balCurrent = ci;
    for (let age = sa; age < ra; age++) {
        currentMap.set(age, balCurrent);
        if (inheritanceAge > 0 && age === inheritanceAge) { balCurrent += inheritanceAmount; }
        for (let month = 1; month <= 12; month++) {
            balCurrent = (balCurrent + (age < stopAge ? mc : 0)) * (1 + mRate);
        }
    }

    // Drawdown Phase Data
    const targetDrawdownData = simulateDrawdown(fin, di, cppBenefit, cppStartAge, sa, ra, ea, inf, post);
    const currentDrawdownData = simulateDrawdown(fvOfCurrentPlan, di, cppBenefit, cppStartAge, sa, ra, ea, inf, post);
    targetDrawdownData.forEach(d => targetMap.set(d.age, d.balance));
    currentDrawdownData.forEach(d => currentMap.set(d.age, d.balance));
    
    // --- 5. RENDER CHART (with ANNOTATIONS) ---
    const factor = (age) => showFuture ? 1 : Math.pow(1 + inf, age - sa);
    const endOfChart = drawdownType === 'perpetual' ? 100 : ea;
    const allAges = Array.from({length: ea - sa + 1}, (_, i) => sa + i);
    const chartLabels = allAges.filter(age => age <= endOfChart);
    
    finChart.data.labels = chartLabels;
    finChart.data.datasets[0].data = chartLabels.map(age => (targetMap.get(age) || 0) / factor(age));
    finChart.data.datasets[1].data = chartLabels.map(age => (currentMap.get(age) || 0) / factor(age));

    const isDark = document.body.classList.contains('dark');
    const annotationLabelBg = isDark ? 'rgba(68, 68, 68, 0.9)' : 'rgba(0, 0, 0, 0.7)';
    const annotationLabelColor = '#fff';
    finChart.options.plugins.annotation.annotations = {
        startAgeLine: { type: 'line', xMin: sa, xMax: sa, borderColor: 'green', borderDash: [6, 6], borderWidth: 2, label: { content: 'Start Age', enabled: true, position: {x:'center', y:'end'}, yAdjust: 8, backgroundColor: annotationLabelBg, color: annotationLabelColor }},
        retireAgeLine: { type: 'line', xMin: ra, xMax: ra, borderColor: 'blue', borderDash: [6, 6], borderWidth: 2, label: { content: 'Retire Age', enabled: true, position: {x:'center', y:'end'}, yAdjust: 8, xAdjust: -14, backgroundColor: annotationLabelBg, color: annotationLabelColor }},
        endAgeLine: { type: 'line', xMin: ea, xMax: ea, borderColor: 'red', borderDash: [6, 6], borderWidth: 2, label: { content: 'Life Expectancy', enabled: true, position: 'start', yAdjust: -20, backgroundColor: annotationLabelBg, color: annotationLabelColor }}
    };
    
    // --- 6. RENDER TABLE & UPDATE COLORS ---
    let tableHTML = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#1a73e8;color:#fff;"><th style="padding:8px;">Age</th><th style="padding:8px;">Target Plan ($)</th><th style="padding:8px;">Current Plan ($)</th></tr></thead><tbody>';
    const zeroAge = allAges.find(age => currentMap.get(age) <= 1 && age >= ra);
    const finalFiveStartAge = zeroAge ? Math.max(ra, zeroAge - 5) : null;
    
    chartLabels.forEach(age => {
        let showRow = (age - sa) % 5 === 0 || age === sa || age === ra || age === ea || (finalFiveStartAge && age >= finalFiveStartAge && age <= zeroAge);
        if (!showRow) return;

        const tp = targetMap.get(age) / factor(age);
        const cp = currentMap.get(age) / factor(age);
        
        let rowClass = (age === ra) ? 'retirement-row' : '';
        if (age === ra && fvOfCurrentPlan >= fin) {
            rowClass += ' on-track-green';
        }
        
        tableHTML += `<tr class="${rowClass}"><td style="padding:8px;text-align:center;">${age}</td><td style="padding:8px;text-align:right;">$${(tp || 0).toLocaleString(undefined, {maximumFractionDigits:0})}</td><td style="padding:8px;text-align:right;">$${(cp || 0).toLocaleString(undefined, {maximumFractionDigits:0})}</td></tr>`;
    });
    tableHTML += '</tbody></table>';
    document.getElementById("tableView").innerHTML = tableHTML;
    
    isCurrentPlanSuccessful = fvOfCurrentPlan >= fin && currentMap.get(ea) > 0;
    updateChartColors();
    saveSettings();
}



      [['inflationRate','inflationRateText'],
       ['preReturn','preReturnText'],
       ['postReturn','postReturnText'],
       ['startAge','startAgeText'],
       ['retireAge','retireAgeText'],
       ['stopAge', 'stopAgeText'], 
       ['endAge','endAgeText']].forEach(pair=>{
        const [sl,tx]=pair, slider=els[sl], text=els[tx];
        slider.addEventListener('input',()=>{
          const whole=Math.round(slider.value);
          slider.value=whole;
          text.value=whole;
          calculateFIN();
        });
        text.addEventListener('change',()=>{
          let v=parseFloat(text.value);
          if(isNaN(v)) v=+slider.min;
          slider.value=Math.min(Math.max(v,+slider.min),+slider.max);
          text.value=slider.value;
          calculateFIN();
        });
      });
let debounceTimeout;
document.querySelectorAll('input[type="number"]').forEach(inp => {
  inp.addEventListener('input', () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      calculateFIN();
    }, 300); // 300ms debounce
  });
});

      function exportPDF(){
        html2pdf().set({margin:0.5,filename:'FIN_tool.pdf',
          image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},
          jsPDF:{unit:'in',format:'letter'}}).from(document.body).save();
      }

      function resetDefaults(){
  localStorage.removeItem('finToolSettings');
  els.currentInvestment.value=0;
  els.desiredIncome.value=2000;
  els.monthlyContribution.value=100;
   els.cppBenefit.value=0;
   els.cppStartAge.value=65;
  els.stopAge.value=65; els.stopAgeText.value=65;
  els.inheritanceAmount.value=0;
  els.inheritanceAge.value=0;
  els.inflationRate.value=2; els.inflationRateText.value=2;
  els.preReturn.value=9; els.preReturnText.value=9;
  els.postReturn.value=7; els.postReturnText.value=7;
  els.startAge.value=25; els.startAgeText.value=25;
  els.retireAge.value=65; els.retireAgeText.value=65;
  els.endAge.value=85; els.endAgeText.value=85;
  els.ageWarning.style.display='none';
  calculateFIN();
}

      function downloadHTML(){
        const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='TeamCanada_FIN_Tool_v1.9.html';
        a.textContent='Download your FIN Tool';
        a.style.display='block'; a.style.margin='20px auto'; a.style.color='#1565c0'; a.style.textAlign='center';
        document.getElementById('downloadLinkContainer').innerHTML=''; document.getElementById('downloadLinkContainer').appendChild(a);
        window.scrollTo(0,document.body.scrollHeight);
      }

      // Initial load
      loadSettings();
      // Set correct label on toggle
const drawdownInitial = document.getElementById("drawdownToggle").checked;
document.getElementById("modeLabel").textContent = drawdownInitial ? "Forever (FIRE style)" : "Life Expectancy";

      calculateFIN();

      // FINAL FIX ‚Äî expose functions to window so buttons work:
      window.exportPDF = exportPDF;
      window.resetDefaults = resetDefaults;
      window.downloadHTML = downloadHTML;

    });

  </script>
  <script>
function autoscaleInputs() {
  const inputs = document.querySelectorAll('.autoscale');
  inputs.forEach(input => {
    const maxWidth = input.clientWidth;


    const testSpan = document.createElement('span');
    const computed = window.getComputedStyle(input);

    // üß† Clone exact font styling from input
    testSpan.style.visibility = 'hidden';
    testSpan.style.position = 'absolute';
    testSpan.style.whiteSpace = 'nowrap';

    testSpan.style.fontFamily = computed.fontFamily;
    testSpan.style.fontWeight = computed.fontWeight;
    testSpan.style.letterSpacing = computed.letterSpacing;
    testSpan.style.fontStyle = computed.fontStyle;
    testSpan.style.padding = computed.padding;
    testSpan.style.border = computed.border;
    testSpan.style.boxSizing = computed.boxSizing;

    const maxFontSize = 18;
    const minFontSize = 6;
    let fontSize = maxFontSize;

    testSpan.textContent = input.value;
    testSpan.style.fontSize = fontSize + 'px';
    document.body.appendChild(testSpan);

    while ((testSpan.offsetWidth + 1) > maxWidth && fontSize > minFontSize) {
      fontSize--;
      testSpan.style.fontSize = fontSize + 'px';
    }

    input.style.fontSize = fontSize + 'px';
    document.body.removeChild(testSpan);

    // Optional: Show full value on hover
    input.title = input.value;
  });
}

// ‚úÖ Run initially and keep rechecking every 500ms
document.addEventListener('DOMContentLoaded', () => {
  autoscaleInputs();
  setInterval(autoscaleInputs, 500);
});
</script>

<!-- tooltip tippy-->
<script>
  function applyTippyTheme() {
    const tippyTheme = document.body.classList.contains('dark') ? 'dark' : 'light';

    tippy('[data-tooltip]', {
      content(reference) {
        return reference.getAttribute('data-tooltip');
      },
      theme: tippyTheme,
      placement: 'top',
      maxWidth: 240,
      allowHTML: true,
      animation: 'shift-away',
      delay: [100, 100],
      offset: [0, 10],
      inlinePositioning: true,
      popperOptions: {
        modifiers: [
          {
            name: 'preventOverflow',
            options: {
              boundary: 'window'
            }
          }
        ]
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    applyTippyTheme();

    const observer = new MutationObserver(() => {
      document.querySelectorAll('[data-tippy-root]').forEach(el => el.remove());
      applyTippyTheme();
    });

    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  });
</script>




<script>
  // This script creates a small box to display the window width.
  const widthDisplay = document.createElement('div');
  widthDisplay.style.position = 'fixed';
  widthDisplay.style.bottom = '10px';
  widthDisplay.style.right = '10px';
  widthDisplay.style.padding = '5px 10px';
  widthDisplay.style.background = 'rgba(0, 0, 0, 0.7)';
  widthDisplay.style.color = 'white';
  widthDisplay.style.fontFamily = 'sans-serif';
  widthDisplay.style.borderRadius = '5px';
  widthDisplay.style.zIndex = '9999';
  document.body.appendChild(widthDisplay);

  function updateWidth() {
    widthDisplay.textContent = `Width: ${window.innerWidth}px`;
  }

  window.addEventListener('resize', updateWidth);
  updateWidth(); // Show initial width
</script>
<script>


function calcInput(char) {
  if (char === '.' && calcBuffer.split(/[\+\-\*\/]/).pop().includes('.')) return;
  calcBuffer += char;
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcClear() {
  calcBuffer = "";
  document.getElementById('calcDisplay').value = "";
}
function calcBackspace() {
  calcBuffer = calcBuffer.slice(0, -1);
  document.getElementById('calcDisplay').value = calcBuffer;
}
function calcEquals() {
  try {
    if (/^[0-9+\-*/.() ]+$/.test(calcBuffer)) {
      let result = eval(calcBuffer);
      document.getElementById('calcDisplay').value = result;
      calcBuffer = String(result);
    } else {
      document.getElementById('calcDisplay').value = "Err";
      calcBuffer = "";
    }
  } catch {
    document.getElementById('calcDisplay').value = "Err";
    calcBuffer = "";
  }
}

document.addEventListener('keydown', function (e) {
  const isCalcVisible = !document.getElementById('basicCalculator').classList.contains('hidden');
  if (!isCalcVisible) return;

  const key = e.key;

  if (/\d/.test(key)) {
    calcInput(key); // numbers 0‚Äì9
  } else if (key === '+' || key === '-' || key === '*' || key === '/' || key === '.') {
    calcInput(key);
  } else if (key === 'Enter' || key === '=') {
    e.preventDefault(); // prevent form submission if any
    calcEquals();
  } else if (key === 'Backspace') {
    e.preventDefault();
    calcBackspace();
  } else if (key === 'Escape') {
    calcClear();
  }
});

</script>

<script>
(function () {
  const el = document.getElementById("basicCalculator");
  const handle = document.getElementById("calcDragHandle");
  let offsetX = 0, offsetY = 0, isDragging = false;

  // Restore position if saved
  const savedLeft = localStorage.getItem("calcLeft");
  const savedTop = localStorage.getItem("calcTop");

  if (savedLeft !== null && savedTop !== null) {
    el.style.left = savedLeft + "px";
    el.style.top = savedTop + "px";
    el.style.right = ""; // Clear right to avoid layout conflict
  }

  function startDrag(x, y) {
    isDragging = true;
    offsetX = x - el.offsetLeft;
    offsetY = y - el.offsetTop;
    el.style.position = "fixed";
    document.body.style.userSelect = "none";
  }

  function dragTo(x, y) {
    if (!isDragging) return;
    const left = x - offsetX;
    const top = y - offsetY;
    el.style.left = `${left}px`;
    el.style.top = `${top}px`;
    el.style.right = ""; // Clear right so left takes effect
    localStorage.setItem("calcLeft", left);
    localStorage.setItem("calcTop", top);
  }

  function stopDrag() {
    isDragging = false;
    document.body.style.userSelect = "";
  }

  // Mouse events
  handle.addEventListener("mousedown", e => startDrag(e.clientX, e.clientY));
  document.addEventListener("mousemove", e => dragTo(e.clientX, e.clientY));
  document.addEventListener("mouseup", stopDrag);

  // Touch events
  handle.addEventListener("touchstart", e => {
    const touch = e.touches[0];
    startDrag(touch.clientX, touch.clientY);
  }, { passive: false });

  document.addEventListener("touchmove", e => {
    if (!isDragging) return;
    const touch = e.touches[0];
    dragTo(touch.clientX, touch.clientY);
  }, { passive: false });

  document.addEventListener("touchend", stopDrag);
})();
</script>




</body>
</html>
